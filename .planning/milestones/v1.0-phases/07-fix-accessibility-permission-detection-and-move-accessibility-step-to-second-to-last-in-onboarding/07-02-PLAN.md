---
phase: 07-fix-accessibility-permission-detection-and-move-accessibility-step-to-second-to-last-in-onboarding
plan: 02
type: execute
wave: 2
depends_on: [07-01]
files_modified:
  - src/components/Onboarding/StepAccessibility.tsx
  - src/components/Overlay.tsx
autonomous: false
requirements: [SETT-04]

must_haves:
  truths:
    - "After clicking Open System Settings in onboarding, permission is auto-detected within 1-2 seconds of granting without clicking Check Again"
    - "On grant detection during onboarding, green checkmark shows for ~1 second then auto-advances to Done step"
    - "When accessibility is skipped, a compact amber badge (not multi-line banner) appears in the overlay with tooltip and click-to-open-settings"
    - "Badge auto-disappears when permission is granted in the background (no restart needed)"
  artifacts:
    - path: "src/components/Onboarding/StepAccessibility.tsx"
      provides: "Auto-polling after Open System Settings click with 1.5s interval"
      contains: "setInterval"
    - path: "src/components/Overlay.tsx"
      provides: "Compact warning badge with Radix tooltip replacing multi-line banner"
      contains: "Tooltip.Provider"
  key_links:
    - from: "src/components/Onboarding/StepAccessibility.tsx"
      to: "check_accessibility_permission (Rust dual-check from Plan 01)"
      via: "invoke('check_accessibility_permission') in polling interval"
      pattern: "check_accessibility_permission"
    - from: "src/components/Overlay.tsx"
      to: "check_accessibility_permission (Rust dual-check from Plan 01)"
      via: "invoke('check_accessibility_permission') in background polling interval"
      pattern: "setInterval.*check_accessibility_permission"
---

<objective>
Add auto-polling to StepAccessibility for instant grant detection and replace the Overlay's multi-line accessibility banner with a compact badge that auto-disappears.

Purpose: Users should not need to click "Check Again" after granting accessibility in System Settings -- polling detects it automatically. The overlay warning should be concise (compact badge with tooltip) rather than a multi-line banner, and should disappear on its own when permission is eventually granted.

Output: Updated StepAccessibility.tsx with polling, updated Overlay.tsx with compact Radix tooltip badge and background polling.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-fix-accessibility-permission-detection-and-move-accessibility-step-to-second-to-last-in-onboarding/07-CONTEXT.md
@.planning/phases/07-fix-accessibility-permission-detection-and-move-accessibility-step-to-second-to-last-in-onboarding/07-RESEARCH.md
@.planning/phases/07-fix-accessibility-permission-detection-and-move-accessibility-step-to-second-to-last-in-onboarding/07-01-SUMMARY.md
@src/components/Onboarding/StepAccessibility.tsx
@src/components/Overlay.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add auto-polling to StepAccessibility and compact badge to Overlay</name>
  <files>src/components/Onboarding/StepAccessibility.tsx, src/components/Overlay.tsx</files>
  <action>
**StepAccessibility.tsx -- Add polling after Open System Settings:**

1. Add a `pollingActive` state (`useState<boolean>(false)`) and a `mountedRef` (`useRef<boolean>(true)`).

2. Add a cleanup useEffect for mountedRef:
   ```typescript
   useEffect(() => {
     return () => { mountedRef.current = false; };
   }, []);
   ```

3. Add a polling useEffect that starts when `pollingActive` becomes true:
   ```typescript
   useEffect(() => {
     if (!pollingActive) return;
     const intervalId = setInterval(async () => {
       if (!mountedRef.current) return;
       try {
         const result = await invoke<boolean>("check_accessibility_permission");
         if (result && mountedRef.current) {
           clearInterval(intervalId);
           setGranted(true);
           useOverlayStore.getState().setAccessibilityGranted(true);
           setTimeout(() => {
             if (mountedRef.current) onNext();
           }, 1000);
         }
       } catch {
         // Silent -- keep polling
       }
     }, 1500);
     return () => clearInterval(intervalId);
   }, [pollingActive]); // eslint-disable-line react-hooks/exhaustive-deps
   ```

4. Update `handleOpenSettings` to set `pollingActive = true` after invoking open_accessibility_settings:
   ```typescript
   const handleOpenSettings = async () => {
     try {
       await invoke("open_accessibility_settings");
     } catch {
       // Best-effort
     }
     setPollingActive(true);
   };
   ```

5. Add `useRef` to the imports from "react" (already has useEffect, useState).

6. The initial `checkPermission()` call on mount stays as-is (calls request_accessibility_permission with prompt:true for the system dialog). The polling uses `check_accessibility_permission` (no prompt, silent dual-check from Plan 01).

7. The "Check Again" button and "Continue" button remain unchanged -- polling supplements them, it does not replace manual checking.

**Overlay.tsx -- Replace multi-line banner with compact badge + background polling:**

1. Add imports at the top:
   ```typescript
   import * as Tooltip from "@radix-ui/react-tooltip";
   import { ShieldAlert } from "lucide-react";
   ```

2. Replace the entire accessibility banner block (the `{mode === "command" && !accessibilityGranted && !isDetecting && (...)}` div, lines ~83-114) with a compact badge:
   ```tsx
   {mode === "command" && !accessibilityGranted && !isDetecting && (
     <Tooltip.Provider delayDuration={300}>
       <Tooltip.Root>
         <Tooltip.Trigger asChild>
           <button
             type="button"
             onClick={() => invoke("open_accessibility_settings")}
             className="flex items-center gap-1 text-amber-400/70 hover:text-amber-400 transition-colors cursor-default bg-transparent border-none p-0"
           >
             <ShieldAlert size={12} />
             <span className="text-[11px] font-mono">No AX access</span>
           </button>
         </Tooltip.Trigger>
         <Tooltip.Portal>
           <Tooltip.Content
             className="bg-black/90 text-white/70 text-xs px-2 py-1.5 rounded border border-white/10 max-w-[220px] leading-relaxed"
             sideOffset={4}
           >
             Terminal context and paste require Accessibility permission. Click to open System Settings.
             <Tooltip.Arrow className="fill-black/90" />
           </Tooltip.Content>
         </Tooltip.Portal>
       </Tooltip.Root>
     </Tooltip.Provider>
   )}
   ```

3. Add background polling useEffect inside the Overlay component (after the existing animation useEffect, before the return):
   ```typescript
   // Background polling: auto-hide accessibility badge when permission is granted
   useEffect(() => {
     if (accessibilityGranted) return;
     const intervalId = setInterval(async () => {
       try {
         const result = await invoke<boolean>("check_accessibility_permission");
         if (result) {
           useOverlayStore.getState().setAccessibilityGranted(true);
         }
       } catch {
         // Silent
       }
     }, 5000);
     return () => clearInterval(intervalId);
   }, [accessibilityGranted]);
   ```

   This polls every 5 seconds (less aggressive than onboarding) and clears itself when `accessibilityGranted` becomes true. The badge disappears reactively because it is conditionally rendered based on `accessibilityGranted`.

4. The existing `invoke` import from "@tauri-apps/api/core" is already present -- no change needed.

5. Remove the existing `useState` import if no longer used (check: it IS still used for `animPhase`). Keep it.
  </action>
  <verify>
Run `npm run build` to verify frontend compiles. Grep for "Tooltip.Provider" in Overlay.tsx to confirm badge is present. Grep for "setInterval" in StepAccessibility.tsx to confirm polling is present. Grep for "pollingActive" in StepAccessibility.tsx. Verify no multi-line banner text "Accessibility permission not detected" remains in Overlay.tsx.
  </verify>
  <done>
StepAccessibility auto-polls every 1.5s after user clicks "Open System Settings", detects grant, shows green checkmark for 1s, then auto-advances. Overlay shows a compact amber "No AX access" badge with ShieldAlert icon instead of multi-line banner. Tooltip on hover explains what is limited and how to fix. Click opens System Settings. Background polling every 5s auto-hides the badge when permission is granted without restart.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify accessibility detection and onboarding flow</name>
  <files>none (human verification only)</files>
  <action>
Human verification checkpoint. What was built across Plans 01 and 02:
- Dual-check accessibility detection (AXIsProcessTrusted + AX probe fallback) in Rust
- Reordered onboarding (API Key -> Model -> Accessibility -> Done)
- Auto-polling in StepAccessibility after clicking "Open System Settings" (1.5s interval)
- Compact overlay badge with Radix tooltip replacing multi-line banner
- Background badge polling (5s interval) that auto-hides badge on permission grant
  </action>
  <verify>
**Build and launch:**
1. Run `cargo tauri dev` (or production build if testing unsigned build behavior)

**Test onboarding order (if fresh install or reset onboarding):**
2. Reset onboarding: delete settings.json from Tauri data dir, relaunch
3. Verify step 1 is "API Key" (not Accessibility)
4. Verify step 2 is "Model"
5. Verify step 3 is "Accessibility"
6. Verify step 4 is "Done"

**Test auto-polling on accessibility step:**
7. When you reach the Accessibility step, click "Open System Settings"
8. In System Settings, toggle CMD+K ON in Accessibility list
9. Within ~1-2 seconds, the onboarding should show green checkmark "Accessibility access granted" and auto-advance to Done

**Test compact badge in overlay:**
10. If accessibility was skipped/not granted, press Cmd+Shift+K to open overlay
11. Verify a small amber badge "No AX access" appears (not a multi-line banner)
12. Hover over the badge -- tooltip should explain what is limited
13. Click the badge -- System Settings should open

**Test badge auto-disappear:**
14. With badge visible, grant accessibility in System Settings
15. Within ~5 seconds, the badge should disappear from the overlay without restarting

**Test dual-check on production build (if applicable):**
16. Build with `cargo tauri build`, launch the .app
17. Verify accessibility detection works even if AXIsProcessTrusted returns false
  </verify>
  <done>Type "approved" or describe issues found. All 17 verification steps pass.</done>
</task>

</tasks>

<verification>
1. `npm run build` passes (frontend compiles)
2. StepAccessibility.tsx contains polling interval with 1500ms
3. Overlay.tsx contains Tooltip.Provider with "No AX access" badge text
4. Overlay.tsx contains 5000ms background polling interval
5. No "Accessibility permission not detected" multi-line banner text in Overlay.tsx
6. Human verification of end-to-end flow passes
</verification>

<success_criteria>
- Auto-polling detects accessibility grant within 1-2 seconds during onboarding
- Compact badge replaces multi-line banner in overlay
- Badge tooltip explains limitation and click opens System Settings
- Badge auto-disappears within 5 seconds of permission grant
- Human verification confirms complete flow
</success_criteria>

<output>
After completion, create `.planning/phases/07-fix-accessibility-permission-detection-and-move-accessibility-step-to-second-to-last-in-onboarding/07-02-SUMMARY.md`
</output>

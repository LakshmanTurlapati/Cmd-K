---
phase: 02-settings-configuration
plan: 03
type: execute
wave: 3
depends_on: ["02-02"]
files_modified:
  - src/components/Onboarding/OnboardingWizard.tsx
  - src/components/Onboarding/StepAccessibility.tsx
  - src/components/Onboarding/StepApiKey.tsx
  - src/components/Onboarding/StepModelSelect.tsx
  - src/components/Onboarding/StepDone.tsx
  - src/components/Overlay.tsx
  - src/App.tsx
autonomous: false
requirements:
  - SETT-04

must_haves:
  truths:
    - "First-time user sees onboarding wizard inside the overlay on first launch"
    - "Onboarding step order is: Accessibility permission -> API key entry -> Model selection -> Done"
    - "If user closes overlay mid-onboarding, it resumes at the same step next time"
    - "Onboarding step progress is persisted in settings.json via tauri-plugin-store"
    - "After completing onboarding, subsequent launches go straight to command mode"
    - "Accessibility step checks permission status and can open System Settings"
    - "API key step validates and saves key (reuses AccountTab validation logic)"
    - "Model selection step shows dropdown with pre-selected default (reuses ModelTab logic)"
  artifacts:
    - path: "src/components/Onboarding/OnboardingWizard.tsx"
      provides: "Step orchestrator that reads current step from store and renders correct step component"
      min_lines: 25
    - path: "src/components/Onboarding/StepAccessibility.tsx"
      provides: "Accessibility permission check UI with System Settings launcher"
      min_lines: 25
    - path: "src/components/Onboarding/StepApiKey.tsx"
      provides: "API key entry step with validation (delegates to same logic as AccountTab)"
      min_lines: 30
    - path: "src/components/Onboarding/StepModelSelect.tsx"
      provides: "Model selection step with dropdown"
      min_lines: 20
    - path: "src/components/Onboarding/StepDone.tsx"
      provides: "Completion step with launch button"
      min_lines: 10
  key_links:
    - from: "src/App.tsx"
      to: "src/store/index.ts"
      via: "startup useEffect checks onboardingComplete from settings.json"
      pattern: "onboardingComplete.*openOnboarding"
    - from: "src/components/Onboarding/OnboardingWizard.tsx"
      to: "src/store/index.ts"
      via: "reads onboardingStep, calls setOnboardingStep"
      pattern: "onboardingStep.*setOnboardingStep"
    - from: "src/components/Onboarding/StepAccessibility.tsx"
      to: "check_accessibility_permission / open_accessibility_settings"
      via: "invoke() Tauri IPC"
      pattern: "invoke.*check_accessibility_permission|invoke.*open_accessibility_settings"
    - from: "src/components/Overlay.tsx"
      to: "src/components/Onboarding/OnboardingWizard.tsx"
      via: "mode === onboarding renders OnboardingWizard"
      pattern: "mode.*onboarding.*OnboardingWizard"
---

<objective>
Build the step-by-step onboarding wizard that guides first-time users through Accessibility permissions, API key setup, and model selection inside the existing overlay panel, with progress persistence across app restarts.

Purpose: Ensures new users complete all required setup (Accessibility permission + API key + model selection) before using the app. Tracks progress so partially completed onboarding resumes where the user left off.
Output: Onboarding wizard components, App.tsx startup check, overlay integration, human verification of complete Phase 2 experience.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-settings-configuration/02-CONTEXT.md
@.planning/phases/02-settings-configuration/02-RESEARCH.md
@.planning/phases/02-settings-configuration/02-01-SUMMARY.md
@.planning/phases/02-settings-configuration/02-02-SUMMARY.md
@src/store/index.ts
@src/components/Overlay.tsx
@src/App.tsx
@src/components/Settings/AccountTab.tsx
@src/components/Settings/ModelTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build onboarding wizard components and wire into Overlay + App startup</name>
  <files>
    src/components/Onboarding/OnboardingWizard.tsx
    src/components/Onboarding/StepAccessibility.tsx
    src/components/Onboarding/StepApiKey.tsx
    src/components/Onboarding/StepModelSelect.tsx
    src/components/Onboarding/StepDone.tsx
    src/components/Overlay.tsx
    src/App.tsx
  </files>
  <action>
    Create the Onboarding directory and five component files, then integrate:

    1. **src/components/Onboarding/OnboardingWizard.tsx** -- Step orchestrator:
       - Read `onboardingStep` from useOverlayStore
       - Render a progress indicator at top: 4 dots or step numbers (1/4, 2/4, etc.) showing current position
       - Title: "Welcome to CMD+K" centered
       - Render the current step component based on `onboardingStep`:
         - 0: StepAccessibility
         - 1: StepApiKey
         - 2: StepModelSelect
         - 3: StepDone
       - Each step receives a `onNext` callback that:
         - Increments onboardingStep in Zustand via `setOnboardingStep(step + 1)`
         - Persists the new step to settings.json: `Store.load("settings.json")` -> `store.set("onboardingStep", step + 1)` -> `store.save()`
       - Step 3 (Done) receives an `onComplete` callback that:
         - Sets `onboardingComplete` to true in Zustand
         - Persists: `store.set("onboardingComplete", true)` + `store.save()`
         - Switches mode to "command" via `setMode("command")`
       - "Skip" link at bottom for steps 0-2 that advances to the next step (Accessibility can be granted later)

    2. **src/components/Onboarding/StepAccessibility.tsx** -- Step 0:
       - On mount: call `invoke<boolean>("check_accessibility_permission")` to check current status
       - If already granted: show green Check icon with "Accessibility access granted" text, auto-advance after 1s or show "Continue" button
       - If not granted:
         - Explain briefly: "CMD+K needs Accessibility access to read terminal context" (one sentence)
         - "Open System Settings" button: calls `invoke("open_accessibility_settings")`
         - "Check Again" button: re-calls `invoke<boolean>("check_accessibility_permission")` and updates UI
         - Show "You can grant this later" muted text
       - "Continue" / "Next" button at bottom (works whether permission is granted or not -- user can skip)
       - Clean, minimal UI: no long explanations, no screenshots

    3. **src/components/Onboarding/StepApiKey.tsx** -- Step 1:
       - Reuse the SAME validation and save logic as AccountTab (import shared helper functions or duplicate the pattern inline):
         - Masked input with eye toggle (Eye/EyeOff from lucide-react)
         - Debounced validation via invoke("validate_and_fetch_models")
         - On success: invoke("save_api_key"), setApiKeyStatus("valid"), setModels(models), setApiKeyLast4
         - Status indicators: spinner/check/X
       - On mount: check if key already exists via invoke("get_api_key") -- if valid, show "Key configured" and enable Next
       - "Next" button enabled only when apiKeyStatus === "valid"
       - "Skip" is available but shows muted warning: "You'll need an API key to generate commands"
       - Keep it identical in behavior to AccountTab but with wizard-style layout (centered, with step context)

    4. **src/components/Onboarding/StepModelSelect.tsx** -- Step 2:
       - Read availableModels and selectedModel from store
       - If models are loaded (apiKeyStatus === "valid" from previous step): show dropdown identical to ModelTab
       - Smart default: auto-select "Balanced" model (grok-3) if no selection
       - On selection: persist to settings.json (same pattern as ModelTab)
       - "Next" button always enabled (a default is pre-selected)
       - If no models available (user skipped API key): show muted text "Configure API key first to select a model" with Next button still enabled

    5. **src/components/Onboarding/StepDone.tsx** -- Step 3:
       - Success message: "You're all set!" with brief instructions
       - Show summary: "Hotkey: {currentHotkey}" and "Model: {selectedModel || 'Not configured'}"
       - "Start using CMD+K" button that calls onComplete callback
       - Clean, celebratory but minimal UI (no emojis per project rules)

    6. **Update src/components/Overlay.tsx**:
       - Import OnboardingWizard from `@/components/Onboarding/OnboardingWizard`
       - Replace the placeholder `"Setting up..."` div in the `mode === "onboarding"` branch with `<OnboardingWizard />`
       - Adjust panel width for onboarding mode: use `w-[380px]` (same as settings, consistent wider panel for setup flows)

    7. **Update src/App.tsx** -- Startup onboarding check:
       - Add a new useEffect (runs once on mount, after the hotkey loading effect):
         ```
         const checkOnboarding = async () => {
           const store = await Store.load("settings.json");
           const onboardingComplete = await store.get<boolean>("onboardingComplete");
           if (!onboardingComplete) {
             const onboardingStep = await store.get<number>("onboardingStep") ?? 0;
             // Check if API key already exists (edge case: user saved key then closed)
             try {
               const existingKey = await invoke<string | null>("get_api_key");
               if (existingKey) {
                 // Validate existing key
                 const models = await invoke<XaiModelWithMeta[]>("validate_and_fetch_models", { apiKey: existingKey });
                 setApiKeyStatus("valid");
                 setModels(models);
                 setApiKeyLast4(existingKey.slice(-4));
                 // If step was on apikey, advance past it
                 const effectiveStep = onboardingStep <= 1 ? Math.max(onboardingStep, 1) : onboardingStep;
                 openOnboarding(effectiveStep);
               } else {
                 openOnboarding(onboardingStep);
               }
             } catch {
               openOnboarding(onboardingStep);
             }
           } else {
             // Onboarding done -- also load API key status for settings panel
             try {
               const existingKey = await invoke<string | null>("get_api_key");
               if (existingKey) {
                 setApiKeyLast4(existingKey.slice(-4));
                 const models = await invoke<XaiModelWithMeta[]>("validate_and_fetch_models", { apiKey: existingKey });
                 setApiKeyStatus("valid");
                 setModels(models);
               }
             } catch {
               // Non-fatal: settings panel will show current status
             }
             // Load persisted model selection
             const savedModel = await store.get<string>("selectedModel");
             if (savedModel) setSelectedModel(savedModel);
           }
         };
         checkOnboarding();
         ```
       - This handles: fresh install (shows onboarding), partial onboarding (resumes), completed onboarding (loads API state for settings), edge case of key saved but onboarding not complete
       - Import XaiModelWithMeta type from store, and new store actions (setApiKeyStatus, setModels, setApiKeyLast4, openOnboarding, setSelectedModel)
  </action>
  <verify>
    Run `pnpm tsc --noEmit` -- compiles without errors. Verify all 5 Onboarding component files exist. Verify Overlay.tsx renders OnboardingWizard when mode is "onboarding". Verify App.tsx has the startup onboarding check useEffect.
  </verify>
  <done>
    Onboarding wizard with 4 steps (Accessibility, API Key, Model Select, Done) renders inside overlay. Progress persists across restarts via settings.json. App.tsx startup checks onboarding status and resumes or skips. Edge cases handled (existing key, partial setup).
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 2 settings and onboarding experience</name>
  <files>none</files>
  <action>
    Human verification of the complete Phase 2 settings and onboarding system:
    - Rust backend: Keychain storage (save/get/delete API key), xAI API validation, Accessibility permission check
    - Settings panel with 3 tabs (Account, Model, Preferences) accessible via tray icon and /settings command
    - First-run onboarding wizard with 4 steps inside the overlay
    - API key validation with masked input, model selection with persistence

    Run `pnpm tauri dev` from the project root and verify the following:

    **Onboarding Flow (first run):**
    1. On first launch, overlay should show the onboarding wizard (not command mode)
    2. Step 1 (Accessibility): Should show permission status and "Open System Settings" button
    3. Click "Continue" or "Skip" to proceed to Step 2
    4. Step 2 (API Key): Enter an xAI API key -- should validate after ~800ms pause
    5. Valid key: green check appears, "Next" becomes enabled
    6. Invalid key: red X appears with "Invalid API key" text
    7. Click "Next" to proceed to Step 3
    8. Step 3 (Model Select): Dropdown should show available models with a default selected
    9. Click "Next" to proceed to Step 4
    10. Step 4 (Done): Shows summary, click "Start using CMD+K"
    11. Overlay switches to command mode (normal behavior)

    **Onboarding Persistence:**
    12. Close the app (Cmd+Q from tray) after completing step 2 but before finishing onboarding
    13. Relaunch -- onboarding should resume at step 3 (not restart from beginning)

    **Settings Panel:**
    14. Type "/settings" in the command input -- settings panel should appear with tabs
    15. Click "Account" tab: should show stored API key (masked) with last 4 chars visible
    16. Toggle eye icon: full key revealed/hidden
    17. Click "Model" tab: dropdown shows models, selected model matches onboarding choice
    18. Change model selection: should persist (verify by closing and reopening settings)
    19. Click "Preferences" tab: hotkey configuration should appear (existing HotkeyConfig)
    20. Right-click tray icon -> "Settings...": same settings panel should appear

    **API Key Validation:**
    21. In Account tab, clear the key and enter an invalid one: red X should appear after debounce
    22. Enter a valid key: green check, models should refresh in Model tab

    **Edge Cases:**
    23. Dismiss overlay (click outside or Escape) during onboarding, reopen -- should be at same step
    24. "Set up in Settings" button in API warning (submit without key) -- should open Account tab in settings

    **macOS Keychain:**
    25. A macOS Keychain access dialog may appear on first API key save -- this is expected for unsigned dev builds. Dismiss/allow it.
  </action>
  <verify>Human confirms all 25 verification steps pass. Type "approved" or describe issues.</verify>
  <done>Complete Phase 2 settings and onboarding experience verified by human tester. All requirements SETT-01 through SETT-04 confirmed working.</done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes
2. First-time launch triggers onboarding wizard in overlay
3. Onboarding follows locked step order: Accessibility -> API Key -> Model -> Done
4. Mid-onboarding closure resumes at correct step on relaunch
5. Settings accessible via both tray "Settings..." and "/settings" command
6. API key stored in macOS Keychain (not plaintext config)
7. Model selection persists across restarts
8. Settings auto-save (no save button)
</verification>

<success_criteria>
- New user completes full onboarding flow in overlay
- Returning user (onboarding done) goes straight to command mode
- Settings panel shows current configuration and allows editing
- All SETT-01 through SETT-04 requirements satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-settings-configuration/02-03-SUMMARY.md`
</output>

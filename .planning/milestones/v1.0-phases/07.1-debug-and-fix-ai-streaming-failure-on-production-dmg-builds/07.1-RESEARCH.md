# Phase 07.1: Debug and Fix Terminal Pasting Failure on Production DMG Builds - Research

**Researched:** 2026-02-26
**Domain:** macOS TCC (Transparency, Consent, and Control), AppleScript automation, code signing, Tauri production builds
**Confidence:** HIGH

## Summary

The failure in production DMG builds is NOT an AI streaming issue -- AI streaming and overlay UI work correctly. The actual failure is in `paste_to_terminal`: the AppleScript that types commands into the terminal succeeds partially (terminal activation/focus works) but the keystroke/write-text portion fails silently. This is a **macOS TCC identity mismatch** caused by the app being ad-hoc signed without proper code identity.

**Root cause analysis:** The production build at `/Applications/CMD+K.app` is ad-hoc signed (linker-signed) with identifier `cmd_k-85159e16c0df3971` (a hash). The TCC database stores AppleEvents permission under the bundle identifier `com.lakshmanturlapati.cmd-k`. When `osascript` spawns as a subprocess, macOS TCC identifies the responsible process as `cmd_k-85159e16c0df3971` (the ad-hoc hash), creating an identity mismatch with the stored TCC permission. Additionally, the production build's `Info.plist` is missing `NSAppleEventsUsageDescription`, and the `entitlements.plist` (which contains `com.apple.security.automation.apple-events`) is NOT embedded into the binary -- `codesign -dvvv` shows `Info.plist=not bound` and no entitlements present.

**Primary recommendation:** Properly code-sign the production binary with a stable identity (ad-hoc signing with explicit `--identifier` flag or Developer ID), add `NSAppleEventsUsageDescription` to Info.plist, ensure entitlements are embedded during signing, and add runtime logging to capture osascript failures for future debugging.

<user_constraints>
## User Constraints (from CONTEXT.md)

### Locked Decisions
- Actual failure point: NOT AI streaming -- the failure is in paste_to_terminal (AppleScript-based terminal pasting from Phase 6)
- Terminal gets focus/activation (cursor activates) but no text is typed/pasted
- Affects ALL terminal apps, not just one specific terminal
- Accessibility permissions work correctly in the DMG build
- Terminal/app detection works correctly in the DMG build
- AI query submission and streaming response in overlay UI works correctly
- Only the final step -- writing the command to the terminal -- fails silently
- Diagnosis approach: Check system logs, compare entitlements between dev and production, investigate AppleScript automation permissions, check code signing/notarization effects

### Claude's Discretion
- Specific debugging methodology and tooling
- Whether fix requires entitlements changes, code changes, or both
- Whether to add runtime logging for future production debugging

### Deferred Ideas (OUT OF SCOPE)
None -- discussion stayed within phase scope
</user_constraints>

## Standard Stack

### Core (already in project)
| Library/Tool | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| Tauri | 2.x | App framework, bundler, code signing pipeline | Already in use; its bundler controls entitlements and signing |
| codesign | macOS built-in | Code signing with entitlements | Apple's standard signing tool, used by Tauri bundler |
| osascript | macOS built-in | AppleScript execution | Already used by paste_to_terminal |

### Supporting
| Tool | Purpose | When to Use |
|------|---------|-------------|
| `codesign -dvvv` | Inspect signing identity, entitlements, Info.plist binding | Verification of fix |
| `sqlite3 ~/Library/Application\ Support/com.apple.TCC/TCC.db` | Query user-level TCC database | Verify AppleEvents permissions |
| `sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db"` | Query system-level TCC database | Verify Accessibility permissions |
| `/usr/bin/log show --predicate` | Query macOS unified log for TCC decisions | Diagnose permission failures at runtime |
| `tccutil reset AppleEvents com.lakshmanturlapati.cmd-k` | Reset TCC AppleEvents for the app | Force fresh permission prompt after signing fix |

### Not Needed
| Instead of | Why Not |
|------------|---------|
| Developer ID certificate | Not needed for local/self-distributed DMG; proper ad-hoc signing with stable identifier suffices |
| Notarization | Same -- not needed unless distributing via web download to other machines |

## Architecture Patterns

### Pattern 1: Tauri Info.plist Merge
**What:** Tauri automatically generates Info.plist for the .app bundle. To add custom keys, create a `src-tauri/Info.plist` file -- Tauri merges it with auto-generated values at build time.
**When to use:** Adding NSAppleEventsUsageDescription and any other privacy-related keys.
**Example:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
"http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
  <key>NSAppleEventsUsageDescription</key>
  <string>CMD+K needs to send commands to your terminal application.</string>
</dict>
</plist>
```
**Source:** https://v2.tauri.app/distribute/macos-application-bundle/
**Confidence:** HIGH -- verified from official Tauri v2 docs

### Pattern 2: Entitlements Applied at Code Signing
**What:** The `entitlements.plist` file (containing `com.apple.security.automation.apple-events`) is only embedded into the binary when code signing actually occurs with the entitlements flag. The current build is linker-signed (adhoc without entitlements), so the entitlement is never embedded.
**When to use:** Must ensure Tauri bundler or a post-build script applies entitlements during signing.
**Evidence:** `codesign -dvvv /Applications/CMD+K.app` shows `Info.plist=not bound`, `Internal requirements=none`, confirming entitlements are not applied.
**Confidence:** HIGH -- verified by examining the actual production binary

### Pattern 3: TCC Responsible Process Attribution
**What:** When CMD+K spawns `osascript` as a subprocess, macOS TCC attributes the Apple Event to the parent process (CMD+K), not to osascript. TCC identifies CMD+K by its code signing identity, not its bundle identifier.
**Evidence from system logs:**
```
AUTHREQ_ATTRIBUTION: msgID=28235.1, attribution={
  responsible={
    TCCDProcess: identifier=cmd_k-85159e16c0df3971,
    pid=15714, responsible_path=/Applications/CMD+K.app/Contents/MacOS/cmd-k
  },
  requesting={
    TCCDProcess: identifier=com.apple.osascript,
    pid=28235, binary_path=/usr/bin/osascript
  }
}
```
**Key insight:** TCC uses `cmd_k-85159e16c0df3971` (ad-hoc hash) as the identifier, but the TCC database entry uses `com.lakshmanturlapati.cmd-k` (bundle ID). This mismatch means the stored permission may not be correctly matched.
**Confidence:** HIGH -- verified from actual system logs on the machine

### Pattern 4: Ad-Hoc Signing with Explicit Bundle Identifier
**What:** By default, ad-hoc (linker-signed) binaries get an auto-generated identifier based on the binary hash (e.g., `cmd_k-85159e16c0df3971`). To fix TCC identity matching, re-sign with an explicit identifier matching the bundle ID.
**Example post-build script:**
```bash
codesign --force --sign - \
  --identifier "com.lakshmanturlapati.cmd-k" \
  --entitlements src-tauri/entitlements.plist \
  "/path/to/CMD+K.app"
```
**Why it works:** `--sign -` means ad-hoc signing, `--identifier` explicitly sets the code identity to match the bundle ID, and `--entitlements` embeds the entitlements into the binary. After this, TCC will see `identifier=com.lakshmanturlapati.cmd-k` matching the stored permission.
**Confidence:** HIGH -- standard macOS code signing practice

### Anti-Patterns to Avoid
- **Anti-pattern: Relying on linker-signed identity for TCC:** The linker generates a hash-based identifier that changes on every rebuild. TCC permissions granted to one hash don't transfer to a new build. Always sign with explicit identifier.
- **Anti-pattern: Assuming entitlements are applied without signing:** Tauri's `entitlements.plist` config only takes effect when code signing is performed. Without a signing identity, entitlements are silently ignored.
- **Anti-pattern: Using `tccutil reset` without understanding scope:** `tccutil reset AppleEvents` resets ALL AppleEvents permissions for ALL apps. Use the bundle-identifier-scoped variant instead.

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Code signing | Custom codesign wrapper | Tauri's built-in signing or a simple post-build script | Tauri already has signing pipeline; just configure it |
| TCC permission management | Manual TCC database edits | Standard macOS permission prompts via `NSAppleEventsUsageDescription` | Editing TCC.db directly is fragile and requires SIP disable |
| AppleScript error detection | Silent failure pattern | Capture osascript stderr and surface to user | Current paste.rs already captures stderr but the error may be from TCC blocking before osascript even runs |

**Key insight:** The fix is primarily configuration/signing, not new code. The paste_to_terminal code is correct; the issue is that macOS TCC blocks the Apple Events before they reach the target apps.

## Common Pitfalls

### Pitfall 1: TCC Identity Mismatch on Rebuild
**What goes wrong:** Every ad-hoc (linker-signed) build gets a different hash identifier. If a user grants AppleEvents permission to build N, build N+1 has a different identifier and the permission no longer applies.
**Why it happens:** Ad-hoc signing without `--identifier` flag uses the binary's hash as the identifier.
**How to avoid:** Always sign with `--identifier "com.lakshmanturlapati.cmd-k"` to ensure a stable identity across rebuilds.
**Warning signs:** Permission works once but breaks after a rebuild or update.

### Pitfall 2: Missing NSAppleEventsUsageDescription
**What goes wrong:** macOS silently denies Apple Events to other apps (error -1743) when the sending app's Info.plist lacks `NSAppleEventsUsageDescription`.
**Why it happens:** Required since macOS Mojave (10.14 SDK). Without it, the system never shows the permission dialog.
**How to avoid:** Add `NSAppleEventsUsageDescription` to `src-tauri/Info.plist` (Tauri merges it).
**Warning signs:** No automation permission dialog appears when the app first tries to send Apple Events; osascript returns error -1743 or fails silently.

### Pitfall 3: Entitlements Not Embedded
**What goes wrong:** `entitlements.plist` exists on disk but is not embedded in the binary's code signature.
**Why it happens:** Tauri only applies entitlements during actual code signing. With `signingIdentity: null` in `tauri.conf.json`, no signing occurs and entitlements are never applied.
**How to avoid:** Either set a signing identity in tauri.conf.json or use a post-build script to codesign with entitlements.
**Warning signs:** `codesign -d --entitlements -` shows no output for the app binary.

### Pitfall 4: Separate TCC Entries per Target App
**What goes wrong:** CMD+K has AppleEvents permission to System Events but NOT to iTerm2 or Terminal.app. The `tell application "iTerm2"` block sends an Apple Event directly to iTerm2 (not System Events), requiring a separate TCC entry.
**Why it happens:** Each `tell application "X"` target requires its own TCC authorization.
**How to avoid:** Either restructure AppleScripts to route all actions through System Events, or ensure TCC permission dialogs are triggered for each target app. The current approach for Terminal.app already uses System Events for keystrokes (good), but the `activate` command sent to Terminal.app itself may trigger a TCC prompt.
**Warning signs:** Script works for one terminal but not another; `activate` succeeds but subsequent commands fail.
**Current state:** TCC database shows `cmd-k -> com.apple.systemevents` (granted) but NO entries for `cmd-k -> com.googlecode.iterm2` or `cmd-k -> com.apple.Terminal`.

### Pitfall 5: Dev vs Production TCC Identity Divergence
**What goes wrong:** `cargo tauri dev` runs the binary outside an app bundle, possibly through a different process chain. TCC may attribute the responsible process differently in dev mode vs production mode.
**Why it happens:** In dev mode, the binary runs directly and may inherit TCC permissions from the terminal/IDE that launched it. In production, the .app bundle is an independent process.
**How to avoid:** Test AppleScript pasting from the actual .app bundle (not just `cargo tauri dev`).
**Warning signs:** Everything works in dev mode but fails in production.

## Code Examples

### Post-Build Code Signing Script
```bash
#!/usr/bin/env bash
# Re-sign the app bundle with stable identifier and entitlements
APP_PATH="$1"  # e.g., src-tauri/target/release/bundle/macos/CMD+K.app

codesign --force --deep --sign - \
  --identifier "com.lakshmanturlapati.cmd-k" \
  --entitlements src-tauri/entitlements.plist \
  "$APP_PATH"

echo "Signed with identifier: com.lakshmanturlapati.cmd-k"
codesign -dvvv "$APP_PATH" 2>&1 | grep -E "Identifier|Signature|Info.plist|Internal"
```

### Verifying Entitlements Are Embedded
```bash
# Should show the entitlements XML including com.apple.security.automation.apple-events
codesign -d --entitlements - /Applications/CMD+K.app
```

### Verifying TCC Permissions
```bash
# Check user-level Apple Events permissions
sqlite3 ~/Library/Application\ Support/com.apple.TCC/TCC.db \
  "SELECT service, client, auth_value, indirect_object_identifier
   FROM access WHERE client LIKE '%cmd%';"

# Check system-level Accessibility permission
sqlite3 "/Library/Application Support/com.apple.TCC/TCC.db" \
  "SELECT service, client, auth_value FROM access
   WHERE service='kTCCServiceAccessibility' AND client LIKE '%cmd%';"
```

### Reading System Logs for TCC Decisions
```bash
# Check TCC decisions involving CMD+K and osascript
/usr/bin/log show --predicate \
  'process == "tccd" AND eventMessage CONTAINS "cmd"' \
  --last 1h --style compact
```

### Enhanced paste_to_terminal with Error Logging
```rust
// In paste.rs, after osascript execution:
let output = std::process::Command::new("osascript")
    .arg("-e")
    .arg(&script)
    .output()
    .map_err(|e| format!("failed to spawn osascript: {}", e))?;

if !output.status.success() {
    let stderr = String::from_utf8_lossy(&output.stderr);
    let stdout = String::from_utf8_lossy(&output.stdout);
    eprintln!("[paste] osascript FAILED");
    eprintln!("[paste]   exit code: {:?}", output.status.code());
    eprintln!("[paste]   stderr: {}", stderr.trim());
    eprintln!("[paste]   stdout: {}", stdout.trim());
    eprintln!("[paste]   script length: {} chars", script.len());
    return Err(format!("osascript failed (exit {}): {}",
        output.status.code().unwrap_or(-1), stderr.trim()));
}
```

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Trust ad-hoc signing for TCC | Explicit identifier signing with entitlements | macOS Mojave (10.14) | Apps must have stable code identity for TCC |
| No privacy strings needed | NSAppleEventsUsageDescription required | macOS Mojave (10.14) | Missing string = silent denial of Apple Events |
| Bundle ID in Info.plist sufficient for TCC | Code signing identity must match TCC records | macOS Catalina (10.15)+ | TCC uses code identity, not just bundle ID |

**Deprecated/outdated:**
- Editing TCC.db manually: Requires disabling SIP; no longer reliable for identity-based matching
- `tccutil reset` without scope: Resets all apps, not just target app

## Evidence Summary

### Current Production Build State (verified on machine)
1. **Code signing:** Ad-hoc, linker-signed. Identifier = `cmd_k-85159e16c0df3971` (hash-based, not bundle ID)
2. **Entitlements:** NOT embedded (`codesign -d --entitlements -` returns nothing)
3. **Info.plist:** Missing `NSAppleEventsUsageDescription` key
4. **TCC AppleEvents (user-level):** `com.lakshmanturlapati.cmd-k -> com.apple.systemevents` = ALLOWED (auth_value=2)
5. **TCC Accessibility (system-level):** `com.lakshmanturlapati.cmd-k` = ALLOWED (auth_value=2)
6. **TCC AppleEvents to iTerm2:** NOT present (no entry)
7. **TCC AppleEvents to Terminal.app:** NOT present (no entry)
8. **TCC responsible identifier at runtime:** `cmd_k-85159e16c0df3971` (does NOT match `com.lakshmanturlapati.cmd-k`)

### Why Dev Mode Works
In dev mode (`cargo tauri dev`), the binary likely inherits TCC context from the parent process (Terminal.app or the IDE), which already has established AppleEvents and Accessibility permissions. The binary is not launched as a standalone .app bundle, so TCC attribution follows a different chain.

## Open Questions

1. **Does Tauri bundler support ad-hoc signing with explicit identifier?**
   - What we know: `tauri.conf.json` has `signingIdentity: null` which means no signing occurs. Setting it to `"-"` should trigger ad-hoc signing.
   - What's unclear: Whether Tauri passes `--identifier` and `--entitlements` flags when using ad-hoc signing.
   - Recommendation: Test with `signingIdentity: "-"` first. If Tauri doesn't pass the right flags, use a post-build script.

2. **Will resetting TCC and re-granting fix the identity mismatch?**
   - What we know: The current TCC entry has a csreq blob that may not match the current binary's identity.
   - What's unclear: Whether macOS will prompt for new permission automatically or silently deny.
   - Recommendation: After re-signing, reset TCC for the app (`tccutil reset AppleEvents com.lakshmanturlapati.cmd-k`), then launch and trigger a paste to get a fresh prompt.

3. **Does `activate` in AppleScript trigger a separate TCC entry for the target app?**
   - What we know: `activate`, `open`, `open location`, and `quit` are reportedly exempt from TCC Apple Events requirement.
   - What's unclear: Whether this exemption applies universally in recent macOS versions.
   - Recommendation: Test after signing fix; if iTerm2's `write text` fails, it will need its own TCC entry which means the user gets an additional permission prompt.

4. **Should the app use NSAppleScript (in-process) instead of spawning osascript?**
   - What we know: Spawning osascript creates a subprocess. TCC attributes the responsible process to CMD+K (correct) but the extra process hop adds complexity.
   - What's unclear: Whether NSAppleScript (Objective-C API for in-process execution) has better TCC handling.
   - Recommendation: Keep osascript for now -- the issue is identity/signing, not the execution method. NSAppleScript migration is a larger change best deferred.

## Sources

### Primary (HIGH confidence)
- Actual production binary inspection via `codesign -dvvv /Applications/CMD+K.app` -- verified on the development machine
- System TCC database queries via sqlite3 -- verified actual permission state
- macOS unified log (`/usr/bin/log show`) -- verified TCC identity mismatch in real logs
- Tauri v2 macOS Bundle docs: https://v2.tauri.app/distribute/macos-application-bundle/ -- Info.plist merge behavior

### Secondary (MEDIUM confidence)
- https://scriptingosx.com/2020/09/avoiding-applescript-security-and-privacy-requests/ -- TCC responsible process attribution
- https://steipete.me/posts/2025/applescript-cli-macos-complete-guide -- CLI tools and AppleScript TCC requirements
- https://www.jessesquires.com/blog/2018/11/17/executing-applescript-in-mac-app-on-macos-mojave/ -- NSAppleEventsUsageDescription requirement
- Apple Developer Forums: https://developer.apple.com/forums/thread/109561 -- error -1743 and entitlements
- Apple Developer Forums: https://developer.apple.com/forums/thread/750802 -- AppleEvents entitlement behavior
- Apple Developer Forums: https://developer.apple.com/forums/thread/730043 -- TCC and ad-hoc signed binaries

### Tertiary (LOW confidence)
- HackTricks TCC documentation: https://book.hacktricks.wiki/en/macos-hardening/macos-security-and-privilege-escalation/macos-security-protections/macos-tcc/index.html -- general TCC internals reference
- https://www.rainforestqa.com/blog/macos-tcc-db-deep-dive -- TCC database schema reference

## Metadata

**Confidence breakdown:**
- Root cause diagnosis: HIGH - verified via actual binary inspection, TCC database queries, and system logs on the machine
- Fix approach (code signing): HIGH - standard macOS practice, well-documented
- Fix approach (Info.plist): HIGH - verified from Tauri official docs
- TCC identity mismatch: HIGH - confirmed in actual system logs showing `cmd_k-85159e16c0df3971` vs `com.lakshmanturlapati.cmd-k`
- Dev vs production difference: MEDIUM - hypothesis based on TCC attribution model (not directly verified)
- Per-target-app TCC entries: MEDIUM - confirmed by database inspection but exempt commands not fully verified

**Research date:** 2026-02-26
**Valid until:** 2026-03-26 (stable macOS security model; unlikely to change)

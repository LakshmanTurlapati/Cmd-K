---
milestone: v0.1.1
audited: 2026-03-01T21:30:00Z
status: passed
scores:
  requirements: 10/10
  phases: 3/3
  integration: 9/9
  flows: 3/3
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 08-window-identification-history-storage
    items:
      - "history.rs line 48: stale comment says 'MAX_HISTORY_PER_WINDOW (7)' but value is now 50 after Phase 10 change"
  - phase: 10-ai-follow-up-context-per-window
    items:
      - "history.rs line 48: same stale comment (introduced by Phase 8, invalidated by Phase 10 constant change)"
---

# Milestone v0.1.1: Command History & Follow-ups -- Audit Report

**Milestone Goal:** Per-terminal-window command history with arrow key navigation and AI follow-up context that persists across overlay open/close cycles

**Audited:** 2026-03-01
**Status:** PASSED

---

## Phase Summary

| Phase | Name | Plans | Verification | Status |
|-------|------|-------|-------------|--------|
| 8 | Window Identification & History Storage | 3/3 | passed (9/9 must-haves) | Complete |
| 9 | Arrow Key History Navigation | 1/1 | passed (13/13 must-haves) | Complete |
| 10 | AI Follow-up Context Per Window | 2/2 | passed (7/7 must-haves) | Complete |

---

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final |
|--------|-------------|-----------------|---------------------|-----------------|-------|
| WKEY-01 | Stable per-terminal-window key (bundle_id:shell_pid) | Phase 8: SATISFIED | 08-01, 08-02, 08-03 | [x] | satisfied |
| WKEY-02 | Window key captured synchronously before overlay steals focus | Phase 8: SATISFIED | 08-01, 08-02 | [x] | satisfied |
| WKEY-03 | Non-terminal apps fall back to global key | Phase 8: SATISFIED | 08-01 | [x] | satisfied |
| HIST-01 | Arrow-Up recalls previous query for active terminal window | Phase 9: SATISFIED | 09-01 | [x] | satisfied |
| HIST-02 | Arrow-Down navigates forward, restores draft at end | Phase 9: SATISFIED | 09-01 | [x] | satisfied |
| HIST-03 | Draft text preserved during history navigation | Phase 9: SATISFIED | 09-01 | [x] | satisfied |
| HIST-04 | History stores up to 7 queries per window, session-scoped | Phase 8: SATISFIED | 08-01, 08-02 | [x] | satisfied |
| CTXT-01 | AI conversation history persists per window across overlay cycles | Phase 10: SATISFIED | 10-01, 10-02 | [x] | satisfied |
| CTXT-02 | turnHistory restored from per-window map on overlay open | Phase 10: SATISFIED | 10-01 | [x] | satisfied |
| CTXT-03 | Terminal context only in first message, omitted in follow-ups | Phase 10: SATISFIED | 10-01 | [x] | satisfied |

**Orphaned requirements:** None. All 10 REQ-IDs in traceability table appear in at least one VERIFICATION.md.

---

## Cross-Phase Integration

| From | To | Via | Status | Req IDs |
|------|----|-----|--------|---------|
| Phase 8 hotkey.rs | Phase 8 state.rs | Window key stored in AppState.current_window_key | WIRED | WKEY-01, WKEY-02 |
| Phase 8 history.rs | Phase 8 state.rs | get_window_history/add_history_entry read/write AppState.history | WIRED | HIST-04 |
| Phase 8 store/index.ts show() | Phase 8 history.rs | invoke('get_window_key'), invoke('get_window_history') | WIRED | WKEY-01, CTXT-02 |
| Phase 8 store/index.ts submitQuery() | Phase 8 history.rs | invoke('add_history_entry') after streaming | WIRED | HIST-04 |
| Phase 9 useHistoryNavigation | Phase 8 store/index.ts | Reads windowHistory from Zustand for arrow-key recall | WIRED | HIST-01, HIST-02, HIST-03 |
| Phase 9 CommandInput | Phase 9 useHistoryNavigation | Imports hook, uses handleHistoryKey/resetOnSubmit/markEdited | WIRED | HIST-01, HIST-02, HIST-03 |
| Phase 10 store/index.ts show() | Phase 8 windowHistory | Reconstructs turnHistory from windowHistory via flatMap | WIRED | CTXT-01, CTXT-02 |
| Phase 10 ai.rs | Phase 10 store/index.ts | is_follow_up from history.is_empty(), turnHistory passed as history | WIRED | CTXT-03 |
| Phase 10 PreferencesTab | Phase 10 history.rs | invoke('clear_all_history') clears all per-window history | WIRED | CTXT-01 |

**All 9 integration links: WIRED**

---

## E2E User Flows

### Flow 1: Per-Window History Recall
1. User presses Cmd+K from terminal window A -> hotkey handler computes window key (WKEY-01, WKEY-02)
2. Frontend fetches windowHistory for that key (HIST-04)
3. User submits query -> add_history_entry stores it (HIST-04)
4. User dismisses, reopens from same window -> same key, history present
5. User presses Arrow-Up -> recalls previous query (HIST-01)
6. User presses Arrow-Down -> restores draft (HIST-02, HIST-03)

**Status:** Complete end-to-end

### Flow 2: AI Follow-up Context
1. User submits first query -> full terminal context sent (CTXT-03 first message)
2. User dismisses, reopens -> turnHistory reconstructed from windowHistory (CTXT-01, CTXT-02)
3. User submits follow-up -> turnHistory sent as conversation history, terminal context omitted (CTXT-03 follow-up)
4. AI response demonstrates awareness of prior exchange

**Status:** Complete end-to-end

### Flow 3: Cross-Window Isolation
1. User queries on window A -> stored under window A's key
2. User switches to window B -> different window key (WKEY-01)
3. User queries on window B -> stored under window B's key
4. User returns to window A -> only window A's history and turnHistory loaded

**Status:** Complete end-to-end

---

## Tech Debt

| Phase | Item | Severity |
|-------|------|----------|
| 8/10 | history.rs line 48: stale comment says "MAX_HISTORY_PER_WINDOW (7)" but value is now 50 | Info |

**Total: 1 item (informational only, no functional impact)**

---

## Human Verification Items (Aggregated)

These items passed code-level verification but require live macOS testing:

**Phase 8 (5 items):** Multi-tab Cursor IDE window keys, iTerm2 tab differentiation, non-terminal fallback, history survival across overlay cycles, 8th query eviction

**Phase 9 (4 items):** Arrow-Up recall from real history, draft preservation cycle, multi-line first-line detection, textarea auto-resize after long recall

**Phase 10 (3 items):** Follow-up context awareness, per-window isolation with two windows, terminal context omission in network payload

**Total: 12 items requiring live testing**

---

_Audited: 2026-03-01T21:30:00Z_
_Auditor: Claude (gsd-audit-milestone)_

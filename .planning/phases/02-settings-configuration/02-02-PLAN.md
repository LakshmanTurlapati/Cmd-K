---
phase: 02-settings-configuration
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - src/store/index.ts
  - src/components/Overlay.tsx
  - src/components/Settings/SettingsPanel.tsx
  - src/components/Settings/AccountTab.tsx
  - src/components/Settings/ModelTab.tsx
  - src/components/Settings/PreferencesTab.tsx
  - src/App.tsx
  - src-tauri/src/commands/tray.rs
autonomous: true
requirements:
  - SETT-01
  - SETT-02

must_haves:
  truths:
    - "User can enter an API key in the Account tab and see immediate validation (green check or red X)"
    - "User can see available Grok models in a dropdown after API key is validated"
    - "User can select a model and the selection persists across app restarts"
    - "User can access settings via tray icon 'Settings...' menu item"
    - "User can access settings by typing /settings in the overlay command input"
    - "Settings panel has three tabs: Account, Model, Preferences"
    - "API key is displayed masked (dots) with eye icon toggle to reveal"
    - "Model dropdown is disabled until API key is validated"
    - "Changes auto-save immediately without a save button"
  artifacts:
    - path: "src/store/index.ts"
      provides: "Extended Zustand store with settings mode, API key status, model state"
      contains: "OverlayMode"
    - path: "src/components/Settings/SettingsPanel.tsx"
      provides: "Tabbed settings panel with Account, Model, Preferences tabs"
      min_lines: 20
    - path: "src/components/Settings/AccountTab.tsx"
      provides: "API key entry with masked input, validation, status indicators"
      min_lines: 40
    - path: "src/components/Settings/ModelTab.tsx"
      provides: "Model dropdown, usage placeholder, disabled state gating"
      min_lines: 30
    - path: "src/components/Settings/PreferencesTab.tsx"
      provides: "Hotkey configuration (relocated from top-level HotkeyConfig)"
      min_lines: 10
  key_links:
    - from: "src/components/Settings/AccountTab.tsx"
      to: "save_api_key / validate_and_fetch_models"
      via: "invoke() Tauri IPC"
      pattern: "invoke.*save_api_key|invoke.*validate_and_fetch_models"
    - from: "src/components/Settings/ModelTab.tsx"
      to: "src/store/index.ts"
      via: "useOverlayStore for model selection and persistence"
      pattern: "useOverlayStore.*selectedModel"
    - from: "src/components/Overlay.tsx"
      to: "src/components/Settings/SettingsPanel.tsx"
      via: "mode === settings renders SettingsPanel"
      pattern: "mode.*settings.*SettingsPanel"
    - from: "src/App.tsx"
      to: "open-settings event"
      via: "listen() Tauri event from tray"
      pattern: "listen.*open-settings"
---

<objective>
Build the settings panel UI with tabbed layout (Account, Model, Preferences), extend the Zustand store with settings/mode state, wire the /settings command and tray menu entry to open settings mode in the overlay.

Purpose: Gives users a complete interface to enter and validate their xAI API key, select a Grok model, and manage preferences -- all within the existing overlay panel, reusing the same NSPanel window.
Output: Settings panel components, extended store, and dual entry points (tray + /settings command).
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-settings-configuration/02-CONTEXT.md
@.planning/phases/02-settings-configuration/02-RESEARCH.md
@.planning/phases/02-settings-configuration/02-01-SUMMARY.md
@src/store/index.ts
@src/components/Overlay.tsx
@src/App.tsx
@src-tauri/src/commands/tray.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Zustand store with settings mode, API key status, and model state</name>
  <files>
    src/store/index.ts
  </files>
  <action>
    Extend the existing useOverlayStore in src/store/index.ts with settings and API state management:

    1. Add `OverlayMode` type: `"command" | "onboarding" | "settings"`

    2. Add `XaiModelWithMeta` interface: `{ id: string; label: string }`

    3. Add new state fields to OverlayState interface:
       - `mode: OverlayMode` (default: "command")
       - `onboardingStep: number` (default: 0) -- 0=accessibility, 1=apikey, 2=model, 3=done
       - `onboardingComplete: boolean` (default: false)
       - `apiKeyStatus: "unknown" | "validating" | "valid" | "invalid" | "error"` (default: "unknown")
       - `apiKeyLast4: string` (default: "") -- last 4 chars of stored key for masked display
       - `selectedModel: string | null` (default: null)
       - `availableModels: XaiModelWithMeta[]` (default: [])
       - `settingsTab: string` (default: "account") -- active tab in settings panel

    4. Add new actions to OverlayState interface:
       - `openSettings: (tab?: string) => void` -- sets mode="settings", visible=true, settingsTab to specified tab or "account"
       - `openOnboarding: (step?: number) => void` -- sets mode="onboarding", visible=true, onboardingStep to specified step or 0
       - `setMode: (mode: OverlayMode) => void`
       - `setOnboardingStep: (step: number) => void`
       - `setOnboardingComplete: (complete: boolean) => void`
       - `setApiKeyStatus: (status: "unknown" | "validating" | "valid" | "invalid" | "error") => void`
       - `setApiKeyLast4: (last4: string) => void`
       - `setModels: (models: XaiModelWithMeta[]) => void`
       - `setSelectedModel: (model: string) => void`
       - `setSettingsTab: (tab: string) => void`

    5. Update existing `openSettings` action (currently opens hotkeyConfigOpen):
       - Change to: set mode="settings", visible=true, settingsTab="account", clear input/submitted/showApiWarning, close hotkeyConfigOpen
       - This replaces the old behavior that just opened the hotkey config

    6. Update existing `show` action to also set mode="command" to ensure overlay opens in command mode by default

    7. Update existing `hide` action to also reset mode to "command"

    Keep all existing fields and actions intact. Only add new fields and modify openSettings/show/hide.
  </action>
  <verify>
    Run `pnpm tsc --noEmit` from project root -- TypeScript compiles without errors. Verify store exports OverlayMode and XaiModelWithMeta types.
  </verify>
  <done>
    Zustand store extended with mode switching (command/settings/onboarding), API key validation status tracking, model selection state, and settings tab management. All existing functionality preserved.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build Settings panel with Account, Model, and Preferences tabs</name>
  <files>
    src/components/Settings/SettingsPanel.tsx
    src/components/Settings/AccountTab.tsx
    src/components/Settings/ModelTab.tsx
    src/components/Settings/PreferencesTab.tsx
  </files>
  <action>
    Create the Settings directory and four component files:

    1. **src/components/Settings/SettingsPanel.tsx** -- Root tabbed settings component:
       - Import `useOverlayStore` for settingsTab and setSettingsTab
       - Build a custom tab UI (do NOT use shadcn Tabs -- no shadcn/ui directory exists yet and adding it would require CLI setup; keep it simple with Tailwind):
         - Three tab buttons: "Account", "Model", "Preferences"
         - Active tab has `border-b-2 border-white/70 text-white` styling
         - Inactive tabs have `text-white/40 hover:text-white/60`
         - Tab bar at top with `border-b border-white/10 mb-3`
       - Render the active tab's content component below the tab bar
       - Include a "Back" button (or left arrow) at top-left to return to command mode: calls `setMode("command")`
       - Title "Settings" centered at top

    2. **src/components/Settings/AccountTab.tsx** -- API key entry and validation:
       - State: `inputValue` (string), `revealed` (boolean for mask toggle)
       - On mount (useEffect), check if API key exists: `invoke<string | null>("get_api_key")`
         - If key exists, set `apiKeyLast4` to last 4 chars, set `apiKeyStatus` to "unknown" initially, then validate it via `invoke<XaiModelWithMeta[]>("validate_and_fetch_models", { apiKey: key })`
         - On validation success: setApiKeyStatus("valid"), setModels(models)
         - On validation failure: setApiKeyStatus("invalid")
       - Input field with `type={revealed ? "text" : "password"}` for masking
       - Eye / EyeOff icon from lucide-react to toggle `revealed` state
       - Debounced validation: when inputValue changes and length > 10, wait 800ms then:
         - setApiKeyStatus("validating")
         - `invoke<XaiModelWithMeta[]>("validate_and_fetch_models", { apiKey: inputValue })`
         - On success: `invoke("save_api_key", { key: inputValue })`, setApiKeyStatus("valid"), setModels(models), setApiKeyLast4(inputValue.slice(-4))
         - On "invalid_key" error: setApiKeyStatus("invalid")
         - On other error: setApiKeyStatus("error")
       - Status indicators next to input:
         - "unknown": nothing shown
         - "validating": small spinner (animate-spin on a Loader2 icon from lucide-react)
         - "valid": green Check icon from lucide-react
         - "invalid": red X icon from lucide-react with "Invalid API key" text
         - "error": red AlertCircle icon with "Validation failed" text
       - When a stored key exists and user hasn't typed: show masked display `"****...{last4}"` as placeholder
       - Delete key button: small "Remove" text button that calls `invoke("delete_api_key")` and resets status
       - No "Get API key" links, no helper text (per user decision -- keep it clean)
       - Auto-save: key is saved to Keychain immediately upon successful validation (no save button)
       - Use useRef for debounce timeout (same pattern as HotkeyRecorder)

    3. **src/components/Settings/ModelTab.tsx** -- Model selection and usage placeholder:
       - Read apiKeyStatus, availableModels, selectedModel from store
       - If apiKeyStatus !== "valid": show disabled dropdown with "Validate API key first" placeholder, grey text
       - If apiKeyStatus === "valid" and availableModels.length > 0:
         - Render a `<select>` dropdown styled with Tailwind (bg-white/10, text-white, rounded-lg, etc.)
         - Each option shows `model.id` with model.label suffix in parentheses if label is non-empty: e.g., "grok-3 (Balanced)"
         - On change: setSelectedModel(value), persist to tauri-plugin-store settings.json via `Store.load("settings.json")` then `store.set("selectedModel", value)` then `store.save()`
       - Smart default: if no model selected and models loaded, auto-select the first model whose label is "Balanced" (or "Recommended"), otherwise first in list
       - On mount: load selectedModel from settings.json via Store, set in Zustand if found
       - Usage dashboard placeholder: simple div with text "No usage recorded yet" and small text "(Available after AI commands are enabled)" -- per research recommendation to defer to Phase 4
       - Label: "Estimated cost" section with muted text explaining it will be available in a future update

    4. **src/components/Settings/PreferencesTab.tsx** -- Hotkey config relocated:
       - Import and render the existing HotkeyConfig component from `@/components/HotkeyConfig`
       - Wrap it with a "Keyboard Shortcut" section heading
       - This is a thin wrapper that places the existing hotkey configuration UI within the settings tab structure
       - No changes to HotkeyConfig.tsx itself -- it already works standalone
  </action>
  <verify>
    Run `pnpm tsc --noEmit` -- all components type-check. Verify all four files exist in src/components/Settings/. Verify AccountTab uses invoke for Keychain commands, not localStorage or direct state storage.
  </verify>
  <done>
    SettingsPanel renders three tabs. AccountTab handles masked API key entry with debounced validation via Rust IPC and Keychain storage. ModelTab shows model dropdown gated on valid API key with persistence. PreferencesTab wraps existing HotkeyConfig.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire Overlay mode switching, tray Settings event, and /settings command</name>
  <files>
    src/components/Overlay.tsx
    src/App.tsx
  </files>
  <action>
    1. **Update src/components/Overlay.tsx** to support mode-based rendering:
       - Import SettingsPanel from `@/components/Settings/SettingsPanel`
       - Read `mode` from useOverlayStore
       - Update the render logic inside the panel div:
         - If `mode === "settings"`: render `<SettingsPanel />`
         - If `mode === "onboarding"`: render placeholder div with text "Setting up..." (Plan 03 will replace this)
         - If `mode === "command"` (default): render existing `<CommandInput>` + `<ResultsArea>` (current behavior)
         - Keep hotkeyConfigOpen check inside command mode only (hotkeyConfig is now also accessible from Preferences tab in settings mode)
       - Remove the top-level hotkeyConfigOpen ternary that currently wraps the entire content -- HotkeyConfig is now accessed through SettingsPanel > PreferencesTab
       - Adjust panel width: when mode === "settings", use `w-[380px]` (slightly wider for tabs); when mode === "command", keep `w-[320px]`

    2. **Update src/App.tsx**:
       - The tray "Settings..." menu item already emits "open-settings" event (see tray.rs line 39)
       - Add a new useEffect listener for the "open-settings" event:
         ```
         listen("open-settings", () => { openSettings(); })
         ```
         This parallels the existing "open-hotkey-config" listener pattern
       - The `/settings` command handling in handleSubmit already calls `openSettings()` (line 73-75) -- verify this still works with the updated store action
       - Wire the "Set up in Settings" button in ResultsArea.tsx: update the onClick to call `openSettings("account")` instead of console.log (import openSettings from store)

    3. **Update src/components/ResultsArea.tsx**:
       - Import useOverlayStore to get openSettings action
       - Replace the `console.log("Open settings requested")` onClick handler with `openSettings("account")` to actually navigate to settings
  </action>
  <verify>
    Run `pnpm tsc --noEmit` -- compiles without errors. Verify Overlay.tsx renders SettingsPanel when mode is "settings". Verify App.tsx listens for "open-settings" event. Verify ResultsArea button calls openSettings.
  </verify>
  <done>
    Overlay switches between command, settings, and onboarding modes. Tray "Settings..." opens settings panel. "/settings" command opens settings panel. "Set up in Settings" button in API warning navigates to Account tab. Dual entry points working.
  </done>
</task>

</tasks>

<verification>
1. `pnpm tsc --noEmit` passes with zero errors
2. Zustand store has mode, apiKeyStatus, selectedModel, availableModels fields
3. SettingsPanel renders 3 tabs: Account, Model, Preferences
4. AccountTab uses invoke("save_api_key") and invoke("validate_and_fetch_models") -- never stores full key in JS state
5. ModelTab dropdown disabled when apiKeyStatus !== "valid"
6. Model selection persisted to settings.json via tauri-plugin-store
7. Tray "Settings..." menu item and "/settings" command both open settings mode
8. "Set up in Settings" button in ResultsArea navigates to settings
</verification>

<success_criteria>
- Settings panel accessible via tray icon and /settings command (two entry points per user decision)
- API key entry with masked input, eye toggle, debounced validation, inline status indicators
- Model dropdown gated on valid API key, persisted selection
- Auto-save on change (no save button per user decision)
- All Keychain operations go through Rust IPC (security boundary maintained)
</success_criteria>

<output>
After completion, create `.planning/phases/02-settings-configuration/02-02-SUMMARY.md`
</output>

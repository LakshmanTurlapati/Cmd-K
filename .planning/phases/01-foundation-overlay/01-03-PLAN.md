---
phase: 01-foundation-overlay
plan: 03
type: execute
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/components/HotkeyConfig.tsx
  - src/components/HotkeyRecorder.tsx
  - src/App.tsx
  - src/store/index.ts
autonomous: false
requirements:
  - OVRL-04
  - OVRL-05

must_haves:
  truths:
    - "User can open Change Hotkey dialog from menu bar tray"
    - "User sees preset hotkey options: Cmd+K, Cmd+Shift+K, Ctrl+Space, and others"
    - "User can select a preset and the hotkey changes immediately at runtime"
    - "User can record a custom shortcut by pressing desired key combination"
    - "Hotkey preference persists across app restarts via tauri-plugin-store"
    - "If hotkey registration fails, user sees an error and can try a different shortcut"
  artifacts:
    - path: "src/components/HotkeyConfig.tsx"
      provides: "Hotkey configuration dialog with preset list and custom recorder"
      min_lines: 60
    - path: "src/components/HotkeyRecorder.tsx"
      provides: "Key combination recorder that captures user's pressed keys"
      min_lines: 40
  key_links:
    - from: "src/components/HotkeyConfig.tsx"
      to: "register_hotkey"
      via: "invoke('register_hotkey') when user selects preset or records custom"
      pattern: "invoke.*register_hotkey"
    - from: "src/components/HotkeyConfig.tsx"
      to: "tauri-plugin-store"
      via: "Store.set() to persist hotkey preference"
      pattern: "store.*set|Store"
    - from: "src/App.tsx"
      to: "src/components/HotkeyConfig.tsx"
      via: "Rendered when open-hotkey-config event received from tray"
      pattern: "open-hotkey-config|HotkeyConfig"
---

<objective>
Implement the hotkey configuration UI: a dialog accessible from the menu bar "Change Hotkey..." item that offers preset hotkey options and a custom shortcut recorder. Selections trigger runtime hotkey re-registration and persist to disk via tauri-plugin-store. Includes a final human verification checkpoint to validate the complete Phase 1 overlay experience.

Purpose: Enable users to resolve the inevitable Cmd+K hotkey conflicts (Safari, VS Code, Slack) without frustration.
Output: Working hotkey configuration dialog with presets, custom recorder, persistence, and runtime re-registration.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-overlay/01-RESEARCH.md
@.planning/phases/01-foundation-overlay/01-CONTEXT.md
@.planning/phases/01-foundation-overlay/01-01-SUMMARY.md
@.planning/phases/01-foundation-overlay/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build hotkey configuration dialog with presets, custom recorder, and persistence</name>
  <files>
    src/components/HotkeyConfig.tsx
    src/components/HotkeyRecorder.tsx
    src/store/index.ts
    src/App.tsx
  </files>
  <action>
    **src/components/HotkeyRecorder.tsx:**
    A focused component that captures key combinations:
    - Renders a bordered box that says "Press a key combination..." when active
    - When the recorder is active (user clicked "Record custom"):
      1. Attach a `keydown` listener that captures modifier keys (Meta, Ctrl, Alt, Shift) + a regular key
      2. Display the captured combination in real-time as user holds keys (e.g., "Cmd + Shift + K")
      3. On `keyup` when at least one modifier + one non-modifier key is captured, finalize the shortcut
      4. Convert the captured keys to Tauri shortcut format: "Super+Shift+KeyK" (Tauri uses "Super" for Cmd on macOS)
    - Mapping for display: Meta -> Cmd (display) / Super (Tauri), Control -> Ctrl / Control, Alt -> Option / Alt, Shift -> Shift
    - Has a "Cancel" button to exit recording mode
    - Props: `onCapture: (shortcut: string) => void`, `onCancel: () => void`
    - Styling: match the overlay panel aesthetic -- dark background, white text, border highlight when recording

    **src/components/HotkeyConfig.tsx:**
    The hotkey configuration dialog/panel:
    - Shown when the Tauri `open-hotkey-config` event is received (from tray "Change Hotkey..." menu item)
    - Layout:
      1. Title: "Change Hotkey" with current hotkey displayed
      2. Preset list as selectable buttons/radio group:
         - Cmd+K (Super+KeyK) -- labeled as "default"
         - Cmd+Shift+K (Super+Shift+KeyK)
         - Ctrl+Space (Control+Space)
         - Option+Space (Alt+Space)
         - Cmd+Shift+Space (Super+Shift+Space)
      3. "Record Custom Shortcut" button that activates `<HotkeyRecorder />`
      4. Status area showing: current selection, "Applying..." during registration, "Success" or "Failed: [reason]" after
      5. "Apply" and "Cancel" buttons at bottom
    - On apply:
      1. Call `invoke('register_hotkey', { shortcutStr: selectedShortcut })` from `@tauri-apps/api/core`
      2. If successful:
         - Save to store using tauri-plugin-store: `import { Store } from '@tauri-apps/plugin-store'; const store = await Store.load('settings.json'); await store.set('hotkey', selectedShortcut); await store.save();`
         - Update Zustand store with new hotkey value
         - Show success feedback, close dialog after 500ms
      3. If registration fails (returns error string):
         - Show error message: "Could not register [shortcut]. It may conflict with another app. Try a different shortcut."
         - Keep dialog open for user to try again
    - On cancel: close dialog without changes
    - Styling: render as a centered panel within the overlay window area, with backdrop overlay. Use the same dark translucent aesthetic as the main overlay.

    **src/store/index.ts updates:**
    Add to the Zustand store:
    - `hotkeyConfigOpen: boolean` -- whether the hotkey config dialog is shown
    - `currentHotkey: string` -- the currently active hotkey (default "Super+KeyK")
    - `openHotkeyConfig: () => void`
    - `closeHotkeyConfig: () => void`
    - `setCurrentHotkey: (shortcut: string) => void`

    **src/App.tsx updates:**
    - Add a Tauri event listener for `open-hotkey-config` that calls `store.openHotkeyConfig()`
    - Conditionally render `<HotkeyConfig />` when `hotkeyConfigOpen` is true
    - On app startup, load persisted hotkey from tauri-plugin-store:
      ```typescript
      const store = await Store.load('settings.json');
      const savedHotkey = await store.get<string>('hotkey');
      if (savedHotkey) {
        await invoke('register_hotkey', { shortcutStr: savedHotkey });
        overlayStore.setCurrentHotkey(savedHotkey);
      }
      ```
      This ensures the persisted hotkey is re-registered on every app launch, not just the default.
  </action>
  <verify>
    - `pnpm tsc --noEmit` compiles without TypeScript errors
    - HotkeyConfig.tsx renders preset list with at least 5 options
    - HotkeyRecorder.tsx captures key combinations and converts to Tauri format
    - Selecting a preset and clicking Apply calls `invoke('register_hotkey')`
    - Error handling shows user-friendly message on registration failure
    - Store persistence uses `@tauri-apps/plugin-store` with `settings.json`
    - App.tsx loads persisted hotkey on startup
  </verify>
  <done>
    Hotkey configuration dialog fully functional: user can select from 5 preset hotkeys or record a custom combination, apply triggers runtime re-registration via Rust backend, success/failure feedback displayed, preference saved to tauri-plugin-store and reloaded on app restart.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 1 overlay experience</name>
  <files>No files modified -- verification only</files>
  <action>
    Human verifies the complete Phase 1 overlay system end-to-end.

    What was built:
    - Tauri v2 app with NSPanel overlay, frosted glass vibrancy, global hotkey
    - Menu bar tray icon with K.png and full menu (Settings, Change Hotkey, About, Quit)
    - No Dock icon (runs as background daemon)
    - React overlay UI: auto-focus input, grow behavior, Enter/Shift+Enter/Escape handling
    - Click-outside dismiss
    - Fade-in + scale-up animation on appear/disappear
    - "API not configured" inline message on submit
    - Hotkey configuration with presets and custom recorder
    - Hotkey persistence across restarts

    Steps to verify:
    1. Run `pnpm tauri dev` from repo root
    2. Verify NO dock icon appears -- only a menu bar icon with "K" branding
    3. Click the menu bar icon -- verify dropdown shows: Settings..., Change Hotkey..., About, Quit CMD+K
    4. Press Cmd+K -- verify overlay appears ~25% down from screen top, centered, with frosted glass effect and shadow
    5. Verify input field is auto-focused -- start typing immediately without clicking
    6. Type "hello world" -- verify text appears in input
    7. Press Shift+Enter -- verify a newline is inserted (input grows)
    8. Press Enter -- verify "API not configured" message appears below input
    9. Press Escape -- verify overlay dismisses with fade-out animation
    10. Press Cmd+K again, then click outside the overlay -- verify it dismisses
    11. Open "Change Hotkey..." from menu bar
    12. Select "Cmd+Shift+K" preset and click Apply
    13. Press Cmd+Shift+K -- verify overlay appears (old Cmd+K should no longer work)
    14. Click "Record Custom Shortcut", press a custom combo (e.g., Ctrl+Space), Apply
    15. Verify the custom shortcut now triggers the overlay
    16. Quit and relaunch the app -- verify the custom shortcut still works (persisted)
    17. Test rapid double-pressing the hotkey -- verify overlay does not flash/flicker (debounce works)

    Resume signal: Type "approved" if all checks pass, or describe specific issues found.
  </action>
  <verify>Human confirms all 17 verification steps pass by typing "approved"</verify>
  <done>All Phase 1 requirements (OVRL-01 through OVRL-05) verified by human testing: overlay appears on hotkey, input works, dismiss works, hotkey configurable and persists, menu bar icon present, no dock icon.</done>
</task>

</tasks>

<verification>
- Complete Phase 1 overlay experience works end-to-end
- All 5 requirements (OVRL-01 through OVRL-05) are met
- Hotkey is configurable and persists across restarts
- Overlay is dismissable via Escape and click-outside
- No Dock icon, menu bar tray functions correctly
- Animation is smooth and Spotlight-like
</verification>

<success_criteria>
User can press a configurable hotkey from any application, see a frosted glass overlay appear with instant keyboard access, type a command description, submit (seeing API not configured placeholder), and dismiss via Escape or click-outside. The hotkey can be changed via presets or custom recording, and the preference persists. The app runs silently in the menu bar with K.png branding.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-overlay/01-03-SUMMARY.md`
</output>

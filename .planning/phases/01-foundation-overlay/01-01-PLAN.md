---
phase: 01-foundation-overlay
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Cargo.toml
  - src-tauri/tauri.conf.json
  - src-tauri/capabilities/default.json
  - src-tauri/src/lib.rs
  - src-tauri/src/commands/window.rs
  - src-tauri/src/commands/hotkey.rs
  - src-tauri/src/commands/tray.rs
  - src-tauri/src/commands/mod.rs
  - src-tauri/src/state.rs
  - src-tauri/src/main.rs
  - src-tauri/entitlements.plist
  - src/main.tsx
  - src/App.tsx
  - package.json
  - tsconfig.json
  - vite.config.ts
  - src/styles.css
autonomous: true
requirements:
  - OVRL-01
  - OVRL-02
  - OVRL-05

must_haves:
  truths:
    - "Global hotkey press shows the overlay window on top of all applications including fullscreen"
    - "Overlay window has frosted glass vibrancy effect matching Spotlight/Raycast aesthetic"
    - "App runs silently with menu bar icon and no Dock icon"
    - "Menu bar dropdown shows Settings, Change Hotkey, About, and Quit CMD+K items"
    - "Hotkey double-fire is debounced so overlay toggles cleanly"
  artifacts:
    - path: "src-tauri/src/lib.rs"
      provides: "Tauri app builder with NSPanel, vibrancy, global hotkey, tray"
      min_lines: 60
    - path: "src-tauri/src/commands/window.rs"
      provides: "show_overlay, hide_overlay commands with NSPanel"
      exports: ["show_overlay", "hide_overlay"]
    - path: "src-tauri/src/commands/hotkey.rs"
      provides: "register_hotkey command with debounce"
      exports: ["register_hotkey"]
    - path: "src-tauri/src/commands/tray.rs"
      provides: "Tray icon setup with K.png and menu"
      exports: ["setup_tray"]
    - path: "src-tauri/src/state.rs"
      provides: "AppState with hotkey and debounce tracking"
      contains: "struct AppState"
    - path: "src-tauri/tauri.conf.json"
      provides: "Window config: transparent, no decorations, hidden by default"
    - path: "src-tauri/entitlements.plist"
      provides: "Apple events entitlement for future Accessibility API"
  key_links:
    - from: "src-tauri/src/commands/hotkey.rs"
      to: "src-tauri/src/commands/window.rs"
      via: "hotkey handler calls show_overlay logic"
      pattern: "show_overlay|position_overlay"
    - from: "src-tauri/src/lib.rs"
      to: "tauri_nspanel"
      via: "plugin init and window.to_panel()"
      pattern: "tauri_nspanel::init|to_panel"
    - from: "src-tauri/src/lib.rs"
      to: "window_vibrancy"
      via: "apply_vibrancy in setup"
      pattern: "apply_vibrancy"
---

<objective>
Scaffold the Tauri v2 project from scratch and implement the complete Rust backend: NSPanel-based floating overlay window with frosted glass vibrancy, global hotkey registration with debounce, menu bar tray icon with K.png branding, and correct macOS window configuration. This creates the foundation that all frontend and configuration plans build upon.

Purpose: Establish the native macOS infrastructure that makes CMD+K feel like a system-level tool (Spotlight/Raycast quality), not a web app.
Output: Working Tauri app that shows/hides a transparent panel on hotkey press, with menu bar icon and no Dock presence.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-overlay/01-RESEARCH.md
@.planning/phases/01-foundation-overlay/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Tauri v2 project with React + TypeScript and install all dependencies</name>
  <files>
    package.json
    tsconfig.json
    vite.config.ts
    src/main.tsx
    src/App.tsx
    src/styles.css
    src-tauri/Cargo.toml
    src-tauri/tauri.conf.json
    src-tauri/capabilities/default.json
    src-tauri/entitlements.plist
  </files>
  <action>
    Create the Tauri v2 project using `pnpm create tauri-app cmd-k --template react-ts` in the repo root (or scaffold manually if the CLI creates a subdirectory -- the project files should live at repo root, not in a nested folder).

    After scaffolding:

    1. **Frontend dependencies** (pnpm):
       - `pnpm add zustand lucide-react tw-animate-css`
       - `pnpm dlx shadcn@latest init` (configure for Tailwind v4, dark mode, neutral palette)
       - Ensure Tailwind v4 CSS-first config is in `src/styles.css` (no tailwind.config.js)

    2. **Rust dependencies** in `src-tauri/Cargo.toml`:
       - `tauri-plugin-global-shortcut` (latest 2.x)
       - `tauri-plugin-positioner` (latest 2.x)
       - `tauri-plugin-store` (latest 2.x)
       - `window-vibrancy = "0.5"` (or latest 0.5.x)
       - `tauri-nspanel = { git = "https://github.com/ahkohd/tauri-nspanel", branch = "v2.1" }`
       - `serde` and `serde_json` for serialization

    3. **tauri.conf.json** window configuration:
       ```json
       {
         "app": {
           "windows": [{
             "label": "main",
             "title": "CMD+K",
             "width": 640,
             "height": 400,
             "minWidth": 480,
             "transparent": true,
             "decorations": false,
             "alwaysOnTop": false,
             "skipTaskbar": true,
             "visible": false,
             "center": true,
             "resizable": false,
             "focus": false
           }]
         }
       }
       ```
       Set `alwaysOnTop: false` because NSPanel level control handles this (Tauri built-in does not work above fullscreen apps per Issue #11488).

    4. **capabilities/default.json**: Grant IPC permissions for all custom commands (`show_overlay`, `hide_overlay`, `register_hotkey`), global-shortcut plugin, positioner plugin, and store plugin.

    5. **entitlements.plist**: Create with `com.apple.security.automation.apple-events` set to true. Do NOT enable app-sandbox (sandboxing blocks Accessibility API needed in Phase 3).

    6. **src/App.tsx**: Minimal React root that renders a placeholder div with transparent background. Set `html, body { background: transparent; }` in styles so vibrancy shows through.

    7. **src/styles.css**: Import Tailwind v4 via `@import "tailwindcss"`. Add `@import "tw-animate-css"`. Set transparent body background. Include custom overlay animation keyframes:
       ```css
       @keyframes overlay-in {
         from { opacity: 0; transform: scale(0.96) translateY(-4px); }
         to   { opacity: 1; transform: scale(1) translateY(0); }
       }
       @keyframes overlay-out {
         from { opacity: 1; transform: scale(1); }
         to   { opacity: 0; transform: scale(0.96) translateY(-4px); }
       }
       ```
  </action>
  <verify>
    - `pnpm install` completes without errors
    - `cd src-tauri && cargo check` compiles without errors (all Rust deps resolve)
    - `src-tauri/tauri.conf.json` has transparent: true, decorations: false, visible: false
    - `src-tauri/entitlements.plist` exists with apple-events entitlement
    - `src/styles.css` contains Tailwind v4 imports and overlay keyframes
  </verify>
  <done>
    Tauri v2 project scaffolded at repo root with React + TypeScript + Vite frontend, all Rust and frontend dependencies installed and compiling, window configured as transparent non-decorated hidden panel, entitlements prepared for future Accessibility API use.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement Rust backend -- NSPanel, vibrancy, global hotkey, tray icon, and window positioning</name>
  <files>
    src-tauri/src/lib.rs
    src-tauri/src/main.rs
    src-tauri/src/state.rs
    src-tauri/src/commands/mod.rs
    src-tauri/src/commands/window.rs
    src-tauri/src/commands/hotkey.rs
    src-tauri/src/commands/tray.rs
  </files>
  <action>
    Implement the complete Rust backend for the overlay app:

    **src-tauri/src/state.rs:**
    - Define `AppState` struct with:
      - `hotkey: Mutex<String>` (current hotkey string, default "Super+K")
      - `last_hotkey_trigger: Mutex<Option<std::time::Instant>>` (for debounce)
      - `overlay_visible: Mutex<bool>` (track visibility state)

    **src-tauri/src/commands/window.rs:**
    - `show_overlay` command:
      1. Get the panel via `app.get_webview_panel("main")`
      2. Position overlay: get current monitor via `current_monitor()` (NOT primary_monitor -- for multi-monitor), compute 25% down from top, centered horizontally. Overlay width = 640px. CRITICAL: divide monitor physical pixels by `scale_factor()` to get logical coordinates (Pitfall 5 from research).
      3. Call `panel.show_and_make_key()` to show NSPanel
      4. Update `overlay_visible` state to true
      5. Emit `overlay-shown` event to frontend (for auto-focus)
    - `hide_overlay` command:
      1. Get panel via `app.get_webview_panel("main")`
      2. Call `panel.order_out(None)` to hide
      3. Update `overlay_visible` state to false
    - `toggle_overlay` internal function:
      1. Check `overlay_visible` state
      2. If visible, call hide; if hidden, call show
      3. This is what the hotkey handler calls

    **src-tauri/src/commands/hotkey.rs:**
    - `register_hotkey` command (takes `shortcut_str: String`):
      1. Unregister all existing shortcuts via `app.global_shortcut().unregister_all()`
      2. Parse shortcut string to `Shortcut` type
      3. Register with handler that:
         a. Only fires on `ShortcutState::Pressed` (ignore Released)
         b. Debounce: check `last_hotkey_trigger` in AppState. If less than 200ms since last trigger, skip (Pitfall 3 -- Tauri double-fire bug #10025)
         c. Update `last_hotkey_trigger` to now
         d. Call `toggle_overlay`
      4. Update `hotkey` in AppState
      5. Return Ok(()) or error string if registration fails
    - Handle registration failure gracefully: if `on_shortcut` returns Err, return the error to frontend (user should see "Hotkey conflict" and be prompted to change)

    **src-tauri/src/commands/tray.rs:**
    - `setup_tray` function (called from lib.rs setup):
      1. Create menu items: "Settings..." (id: settings), "Change Hotkey..." (id: change_hotkey), "About" (id: about), separator, "Quit CMD+K" (id: quit)
      2. Load K.png from repo root as tray icon. Use `include_bytes!` or `Image::from_path` with the correct relative path from src-tauri. The icon should be loaded as a template image for dark/light mode adaptation on macOS.
      3. Build tray with `TrayIconBuilder::new().icon(icon).menu(&menu).menu_on_left_click(false)`
      4. Handle menu events:
         - "settings" -> emit "open-settings" event to frontend (placeholder for Phase 2)
         - "change_hotkey" -> emit "open-hotkey-config" event to frontend
         - "about" -> emit "open-about" event to frontend (placeholder)
         - "quit" -> `app.exit(0)`

    **src-tauri/src/commands/mod.rs:**
    - Re-export all command modules

    **src-tauri/src/lib.rs:**
    - Build Tauri app with:
      1. `tauri_nspanel::init()` plugin
      2. `tauri_plugin_global_shortcut::Builder::new().build()` plugin
      3. `tauri_plugin_positioner::init()` plugin
      4. `tauri_plugin_store::Builder::default().build()` plugin
      5. Manage `AppState` via `.manage(AppState::default())`
    - In `.setup()` closure:
      1. Set `ActivationPolicy::Accessory` FIRST (hides dock icon, fixes Stage Manager glitch -- Pitfall 1)
      2. Get the main webview window
      3. Apply vibrancy: `apply_vibrancy(window, NSVisualEffectMaterial::HudWindow, None, Some(12.0))` for frosted glass with 12px corner radius
      4. Convert window to panel: `window.to_panel().unwrap()`
      5. Configure panel: `set_can_become_key_window(true)`, set level to `NSMainMenuWindowLevel + 1`
      6. Call `setup_tray(app)`
      7. Register default hotkey "Super+K" via the hotkey registration function
      8. Hide window initially
    - Register invoke handlers: `show_overlay`, `hide_overlay`, `register_hotkey`

    **src-tauri/src/main.rs:**
    - Standard Tauri main entry: `fn main() { cmd_k_lib::run(); }` (or whatever the crate name is based on Cargo.toml)
  </action>
  <verify>
    - `cd src-tauri && cargo build` compiles without errors
    - Run `cargo clippy` with no errors (warnings acceptable)
    - Verify `lib.rs` registers all 3 plugins (nspanel, global-shortcut, store)
    - Verify `state.rs` has `AppState` with `Mutex<String>` for hotkey and `Mutex<Option<Instant>>` for debounce
    - Verify `window.rs` uses `current_monitor()` (not `primary_monitor`) and divides by `scale_factor()`
    - Verify `hotkey.rs` has 200ms debounce check
    - Verify `tray.rs` creates all 4 menu items matching CONTEXT.md spec
  </verify>
  <done>
    Complete Rust backend compiles and provides: NSPanel overlay that shows/hides on global hotkey with 200ms debounce, frosted glass HudWindow vibrancy, overlay positioned at 25% down from screen top centered horizontally, menu bar tray icon with K.png and all 4 menu items, no Dock icon via Accessory activation policy. All IPC commands exposed for frontend consumption.
  </done>
</task>

</tasks>

<verification>
- `pnpm tauri build --debug` compiles both frontend and Rust without errors
- App launches with no Dock icon and shows tray icon in menu bar
- Pressing Cmd+K shows transparent panel at ~25% down from screen top
- Pressing Cmd+K again hides the panel (toggle behavior)
- Tray menu shows: Settings..., Change Hotkey..., About, Quit CMD+K
- Clicking "Quit CMD+K" in tray exits the app
- Panel has frosted glass vibrancy effect visible through transparent background
</verification>

<success_criteria>
Tauri v2 app is fully scaffolded and the Rust backend compiles. The app runs as a menu bar daemon with no Dock presence. A global hotkey (Cmd+K) toggles a transparent NSPanel overlay with frosted glass vibrancy, positioned 25% down from screen top. The tray icon uses K.png branding with the correct menu items. All IPC commands are exposed for the frontend UI plan to consume.
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-overlay/01-01-SUMMARY.md`
</output>

---
phase: 07.1-debug-and-fix-ai-streaming-failure-on-production-dmg-builds
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/Info.plist
  - src-tauri/tauri.conf.json
  - src-tauri/src/commands/paste.rs
  - scripts/build-dmg.sh
autonomous: false
requirements: [SETT-04, TERM-01]

must_haves:
  truths:
    - "Production DMG build has stable code signing identity matching bundle ID com.lakshmanturlapati.cmd-k"
    - "Entitlements (com.apple.security.automation.apple-events) are embedded in the signed binary"
    - "Info.plist contains NSAppleEventsUsageDescription so macOS prompts for AppleEvents permission"
    - "paste_to_terminal command successfully writes text to Terminal.app and iTerm2 from the production DMG build"
    - "osascript failures produce actionable error logs with exit code, stderr, and script details"
  artifacts:
    - path: "src-tauri/Info.plist"
      provides: "NSAppleEventsUsageDescription for TCC AppleEvents permission dialog"
      contains: "NSAppleEventsUsageDescription"
    - path: "scripts/build-dmg.sh"
      provides: "Post-build script that re-signs the .app bundle with explicit identifier and entitlements"
      contains: "codesign"
    - path: "src-tauri/src/commands/paste.rs"
      provides: "Enhanced error logging for osascript failures"
      contains: "osascript FAILED"
    - path: "src-tauri/tauri.conf.json"
      provides: "Tauri config with ad-hoc signing identity"
      contains: "signingIdentity"
  key_links:
    - from: "scripts/build-dmg.sh"
      to: "src-tauri/entitlements.plist"
      via: "codesign --entitlements flag"
      pattern: "entitlements\\.plist"
    - from: "src-tauri/Info.plist"
      to: "macOS TCC AppleEvents permission dialog"
      via: "Tauri Info.plist merge at build time"
      pattern: "NSAppleEventsUsageDescription"
    - from: "src-tauri/src/commands/paste.rs"
      to: "osascript subprocess"
      via: "std::process::Command output capture"
      pattern: "osascript.*FAILED"
---

<objective>
Fix terminal pasting failure in production DMG builds by resolving the macOS TCC identity mismatch.

Purpose: The production DMG build's AppleScript-based terminal pasting fails silently because the app is linker-signed with a hash-based identifier (`cmd_k-85159e16c0df3971`) instead of the bundle ID (`com.lakshmanturlapati.cmd-k`). TCC cannot match the stored AppleEvents permission to the running binary. Additionally, `NSAppleEventsUsageDescription` is missing from Info.plist (preventing the permission dialog), and entitlements are not embedded in the binary.

Output: Properly signed production build with embedded entitlements and Info.plist privacy string, enhanced error logging in paste.rs, and a build script that ensures consistent signing across rebuilds.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07.1-debug-and-fix-ai-streaming-failure-on-production-dmg-builds/07.1-RESEARCH.md
@src-tauri/entitlements.plist
@src-tauri/tauri.conf.json
@src-tauri/src/commands/paste.rs
@scripts/build-pkg.sh
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Info.plist and build script with proper code signing</name>
  <files>
    src-tauri/Info.plist
    src-tauri/tauri.conf.json
    scripts/build-dmg.sh
  </files>
  <action>
    **1. Create `src-tauri/Info.plist`** with the NSAppleEventsUsageDescription key. Tauri merges this with the auto-generated Info.plist at build time (per Tauri v2 docs).

    Content:
    ```xml
    <?xml version="1.0" encoding="UTF-8"?>
    <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN"
    "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
    <plist version="1.0">
    <dict>
      <key>NSAppleEventsUsageDescription</key>
      <string>CMD+K needs to send commands to your terminal application.</string>
    </dict>
    </plist>
    ```

    **2. Update `src-tauri/tauri.conf.json`** -- change `"signingIdentity": null` to `"signingIdentity": "-"` in the `bundle.macOS` section. The `"-"` value tells Tauri to use ad-hoc signing, which should cause it to apply the entitlements.plist during signing. Keep the existing `"entitlements": "entitlements.plist"` as-is.

    **3. Create `scripts/build-dmg.sh`** -- a production build script that:
    - Runs `pnpm tauri build --target universal-apple-darwin` (same as existing build-pkg.sh pattern)
    - After Tauri build completes, re-signs the .app bundle with explicit flags:
      ```bash
      codesign --force --deep --sign - \
        --identifier "com.lakshmanturlapati.cmd-k" \
        --entitlements src-tauri/entitlements.plist \
        "$APP_BUNDLE"
      ```
    - Verifies the signing is correct by running `codesign -dvvv` and checking the identifier matches `com.lakshmanturlapati.cmd-k`
    - Verifies entitlements are embedded by running `codesign -d --entitlements -` and checking for `com.apple.security.automation.apple-events`
    - Creates the DMG using `hdiutil create` (similar to the existing build-pkg.sh structure)
    - Prints a reminder to reset TCC permissions: `tccutil reset AppleEvents com.lakshmanturlapati.cmd-k`
    - Prints instructions: after installing the new build, the user should launch it and trigger a paste action -- macOS will show an AppleEvents permission prompt for each target terminal app

    Use the existing `scripts/build-pkg.sh` as a structural template (same preflight checks, same variable naming pattern). The script should be self-contained and idempotent. Do NOT modify build-pkg.sh -- it serves a different purpose (PKG installer).

    **Important notes:**
    - The `--deep` flag in codesign ensures all nested binaries/frameworks are also signed
    - The `--force` flag replaces any existing signature
    - The `--identifier` flag overrides the default hash-based identifier with the stable bundle ID
    - The re-signing step is necessary because Tauri's ad-hoc signing may not pass the `--identifier` flag explicitly
  </action>
  <verify>
    1. `src-tauri/Info.plist` exists and contains `NSAppleEventsUsageDescription`
    2. `src-tauri/tauri.conf.json` has `"signingIdentity": "-"` in `bundle.macOS`
    3. `scripts/build-dmg.sh` exists, is executable, and contains the codesign command with `--identifier "com.lakshmanturlapati.cmd-k"` and `--entitlements`
    4. Run `cat src-tauri/Info.plist | grep NSAppleEventsUsageDescription` -- should match
    5. Run `grep signingIdentity src-tauri/tauri.conf.json` -- should show `"-"`
  </verify>
  <done>
    Info.plist created with NSAppleEventsUsageDescription, tauri.conf.json updated with ad-hoc signing identity, and build-dmg.sh created with proper code signing (explicit identifier + embedded entitlements) and DMG creation.
  </done>
</task>

<task type="auto">
  <name>Task 2: Enhance paste.rs error logging for production debugging</name>
  <files>
    src-tauri/src/commands/paste.rs
  </files>
  <action>
    Enhance the `paste_to_terminal` function in `src-tauri/src/commands/paste.rs` to provide actionable error information when osascript fails in production builds.

    **Changes to the osascript execution block (around line 175-203):**

    After `let output = std::process::Command::new("osascript")...`:

    If `!output.status.success()`:
    - Log exit code, stderr, stdout, script length, bundle_id, and pid
    - Include a hint about TCC permissions in the error message
    - Format: `[paste] osascript FAILED | exit={exit_code} | bundle={bundle_id} | pid={pid} | stderr={stderr} | stdout={stdout} | script_len={len}`

    Also enhance the success path:
    - On success, log slightly more detail: `[paste] paste succeeded | bundle={bundle_id} | pid={pid} | chars={command_len}`

    Additionally, add a **pre-flight TCC hint log** at the very start of `paste_to_terminal` (before the script build):
    - Log a warning if this is likely to fail due to missing permissions:
      ```rust
      eprintln!("[paste] attempting paste | pid={} | bundle_id={} | command_len={}", pid, bundle_id, command.len());
      ```

    The existing `eprintln!` at line 135-138 already logs this info, so just ensure the error path is comprehensive. The key improvement is the FAILED block with structured fields.

    **Do NOT change** the function signature, the script building logic, or the panel resign/re-acquire key window logic. Only enhance logging.
  </action>
  <verify>
    1. `grep -n "osascript FAILED" src-tauri/src/commands/paste.rs` -- should find the enhanced error log
    2. `grep -n "exit=" src-tauri/src/commands/paste.rs` -- should find structured error fields
    3. `cargo check --manifest-path src-tauri/Cargo.toml` -- should compile without errors
  </verify>
  <done>
    paste.rs error logging enhanced with structured fields (exit code, stderr, stdout, bundle_id, pid, script_len) on osascript failure, providing actionable diagnostic information for production debugging.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Build production DMG and verify terminal pasting works</name>
  <files>scripts/build-dmg.sh</files>
  <action>
    Human verification checkpoint. What was built:
    - Created src-tauri/Info.plist with NSAppleEventsUsageDescription (enables macOS permission dialog)
    - Updated tauri.conf.json to use ad-hoc signing (signingIdentity: "-")
    - Created scripts/build-dmg.sh that re-signs with explicit bundle identifier and embeds entitlements
    - Enhanced paste.rs error logging for future production debugging

    Steps to verify:

    **Step 1: Reset existing TCC permissions**
    ```bash
    tccutil reset AppleEvents com.lakshmanturlapati.cmd-k
    ```

    **Step 2: Build production DMG**
    ```bash
    chmod +x scripts/build-dmg.sh
    ./scripts/build-dmg.sh
    ```
    Build output should show:
    - "Signed with identifier: com.lakshmanturlapati.cmd-k"
    - Entitlements verification showing `com.apple.security.automation.apple-events`

    **Step 3: Install the DMG**
    - Open the generated DMG from `dist/` directory
    - Drag CMD+K to Applications (replacing old version)
    - Launch CMD+K from Applications

    **Step 4: Verify code signing**
    ```bash
    codesign -dvvv /Applications/CMD+K.app 2>&1 | grep Identifier
    # Should show: Identifier=com.lakshmanturlapati.cmd-k (NOT a hash)

    codesign -d --entitlements - /Applications/CMD+K.app
    # Should show com.apple.security.automation.apple-events = true
    ```

    **Step 5: Test terminal pasting**
    1. Open Terminal.app (or iTerm2)
    2. Press Cmd+Shift+K to open overlay
    3. Type a query (e.g., "list files in current directory")
    4. Wait for AI response to stream
    5. Press Enter to paste the command to the terminal
    6. **Expected:** macOS shows an AppleEvents permission dialog (first time only) -- click Allow
    7. **Expected:** Command text appears in the terminal input line
    8. Repeat with the other terminal app (iTerm2 or Terminal.app)

    **Step 6: Verify system logs (if pasting still fails)**
    ```bash
    /usr/bin/log show --predicate 'process == "tccd" AND eventMessage CONTAINS "cmd"' --last 5m --style compact
    ```
  </action>
  <verify>
    1. `codesign -dvvv /Applications/CMD+K.app 2>&1 | grep Identifier` shows `com.lakshmanturlapati.cmd-k`
    2. `codesign -d --entitlements - /Applications/CMD+K.app` shows `com.apple.security.automation.apple-events`
    3. Terminal pasting works from the production DMG (command text appears in terminal input line)
  </verify>
  <done>
    Production DMG build verified: code identity matches bundle ID, entitlements embedded, NSAppleEventsUsageDescription triggers permission dialog, and terminal pasting works for Terminal.app and iTerm2. Type "approved" or describe issues.
  </done>
</task>

</tasks>

<verification>
1. `src-tauri/Info.plist` exists with NSAppleEventsUsageDescription key
2. `src-tauri/tauri.conf.json` has `"signingIdentity": "-"` in bundle.macOS
3. `scripts/build-dmg.sh` exists, is executable, contains codesign with --identifier and --entitlements flags
4. `src-tauri/src/commands/paste.rs` has enhanced error logging with structured fields
5. `cargo check --manifest-path src-tauri/Cargo.toml` compiles cleanly
6. Production DMG build produces a binary with:
   - Identifier = com.lakshmanturlapati.cmd-k (not a hash)
   - Entitlements embedded (com.apple.security.automation.apple-events)
   - Info.plist contains NSAppleEventsUsageDescription
7. Terminal pasting works from the production DMG build (after granting AppleEvents permission)
</verification>

<success_criteria>
- Production DMG build has stable code identity matching the bundle ID
- Entitlements are embedded in the signed binary
- NSAppleEventsUsageDescription triggers the macOS permission dialog on first AppleEvents use
- paste_to_terminal successfully writes command text to Terminal.app and iTerm2
- osascript failures produce structured, actionable error logs
</success_criteria>

<output>
After completion, create `.planning/phases/07.1-debug-and-fix-ai-streaming-failure-on-production-dmg-builds/07.1-01-SUMMARY.md`
</output>

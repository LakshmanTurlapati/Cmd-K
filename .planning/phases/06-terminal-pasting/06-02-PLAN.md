---
phase: 06-terminal-pasting
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/store/index.ts
autonomous: false
requirements: [TERM-01]

must_haves:
  truths:
    - "Safe command auto-pastes to terminal immediately after generation completes and destructive check confirms safe"
    - "Destructive command does NOT auto-paste (user must copy manually via existing copy button)"
    - "When autoPasteEnabled is OFF, no auto-paste occurs for any command"
    - "When paste_to_terminal fails (unsupported terminal), clipboard fallback is silently available (already copied)"
    - "Focus shifts to terminal after successful paste"
    - "Overlay stays open after paste (does not dismiss)"
  artifacts:
    - path: "src/store/index.ts"
      provides: "submitQuery paste trigger in completion path"
      contains: "paste_to_terminal"
  key_links:
    - from: "src/store/index.ts"
      to: "src-tauri/src/commands/paste.rs"
      via: "invoke('paste_to_terminal', { command }) call after destructive check"
      pattern: "invoke.*paste_to_terminal"
    - from: "src/store/index.ts"
      to: "Zustand autoPasteEnabled state"
      via: "getState().autoPasteEnabled check before paste"
      pattern: "autoPasteEnabled"
---

<objective>
Wire the paste trigger into the submitQuery completion path and verify the entire auto-paste flow end-to-end.

Purpose: Connect the paste_to_terminal backend command to the streaming completion flow with proper destructive-check ordering, ensuring safe commands auto-paste and destructive commands are blocked from pasting.
Output: Working end-to-end auto-paste pipeline, verified by human testing with Terminal.app and/or iTerm2.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-terminal-pasting/06-CONTEXT.md
@.planning/phases/06-terminal-pasting/06-RESEARCH.md
@.planning/phases/06-terminal-pasting/06-01-SUMMARY.md
@src/store/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire paste_to_terminal invocation into submitQuery completion path</name>
  <files>
    src/store/index.ts
  </files>
  <action>
Restructure the submitQuery success path in `src/store/index.ts` so that the auto-paste fires ONLY after the destructive check resolves. The current code has `check_destructive` in a fire-and-forget `.then()` chain, which creates a race condition with any paste trigger.

Current flow (lines ~387-405):
```
// Auto-copy to clipboard (fire and forget)
navigator.clipboard.writeText(finalText)...

// Check destructive (fire and forget)
invoke("check_destructive", { command: finalText }).then(...)
```

New flow -- replace the entire block from the auto-copy through check_destructive with:
```typescript
// Auto-copy completed response to clipboard (always runs first)
if (finalText) {
  navigator.clipboard.writeText(finalText).catch((err) => {
    console.error("[store] clipboard auto-copy failed:", err);
  });
}

// Check destructive, then conditionally auto-paste
const pasteState = useOverlayStore.getState();
if (pasteState.destructiveDetectionEnabled && finalText) {
  try {
    const destructive = await invoke<boolean>("check_destructive", { command: finalText });
    if (destructive) {
      useOverlayStore.getState().setIsDestructive(true);
      // Destructive: do NOT auto-paste. User copies manually.
    } else {
      // Safe command: auto-paste if enabled
      const afterCheck = useOverlayStore.getState();
      if (afterCheck.autoPasteEnabled && finalText) {
        invoke("paste_to_terminal", { command: finalText }).catch((err) => {
          console.error("[store] auto-paste failed (clipboard fallback available):", err);
        });
      }
    }
  } catch (err) {
    console.error("[store] check_destructive failed:", err);
    // On detection failure, still attempt paste (fail-open for paste, fail-closed for safety badge)
    const afterErr = useOverlayStore.getState();
    if (afterErr.autoPasteEnabled && finalText) {
      invoke("paste_to_terminal", { command: finalText }).catch((pasteErr) => {
        console.error("[store] auto-paste failed:", pasteErr);
      });
    }
  }
} else if (finalText) {
  // Detection disabled: auto-paste if enabled (no safety check)
  const nocheckState = useOverlayStore.getState();
  if (nocheckState.autoPasteEnabled) {
    invoke("paste_to_terminal", { command: finalText }).catch((err) => {
      console.error("[store] auto-paste failed (clipboard fallback available):", err);
    });
  }
}
```

Key ordering guarantees:
- Clipboard copy always runs first (unconditional, fire-and-forget).
- check_destructive is awaited (not fire-and-forget) before paste decision.
- paste_to_terminal is fire-and-forget (errors logged, clipboard already populated as fallback).
- When destructiveDetectionEnabled is OFF, skip destructive check but still paste if autoPasteEnabled is true.
- When check_destructive itself errors, paste anyway (fail-open for paste -- the clipboard is always there).

Do NOT:
- Remove the existing auto-copy (navigator.clipboard.writeText) block -- it must stay.
- Dismiss the overlay after paste -- per CONTEXT.md the overlay stays open.
- Add any visual confirmation indicator for paste -- per CONTEXT.md the command appearing in terminal is confirmation enough.
  </action>
  <verify>
Run `cd "/Users/lakshmanturlapati/Documents/Codes/CMD + K" && npx tsc --noEmit 2>&1 | tail -5` -- zero TypeScript errors.
Verify paste invocation: `grep "paste_to_terminal" src/store/index.ts`
Verify await on check_destructive: `grep "await invoke.*check_destructive" src/store/index.ts`
  </verify>
  <done>
submitQuery completion path awaits check_destructive before deciding to paste. Safe commands invoke paste_to_terminal when autoPasteEnabled is true. Destructive commands skip paste. Clipboard fallback is implicit via the unconditional auto-copy that runs first.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify auto-paste end-to-end</name>
  <files>None (verification only)</files>
  <action>
Human verification of the complete auto-paste pipeline. Run `cd "/Users/lakshmanturlapati/Documents/Codes/CMD + K" && pnpm tauri dev` with Terminal.app or iTerm2 as the active terminal, then execute all 5 test scenarios below.

**Test 1: Safe command auto-paste (Terminal.app or iTerm2)**
1. Open a terminal window (Terminal.app or iTerm2)
2. Press Cmd+Shift+K to open the overlay
3. Type a safe query like "list files in current directory" and press Enter
4. After the command streams in, verify: the generated command appears in the terminal input line (NOT executed -- just typed there)
5. Verify: focus shifts to the terminal
6. Verify: the overlay stays open (does not dismiss)

**Test 2: Destructive command does NOT auto-paste**
1. Bring the terminal back to foreground
2. Press Cmd+Shift+K to open overlay
3. Type something that produces a destructive command, e.g. "delete all files in this folder"
4. After the command streams in and the red "Destructive" badge appears, verify: the command does NOT appear in the terminal input line
5. The user can still copy manually using the existing click-to-copy

**Test 3: Auto-paste toggle OFF**
1. Open Settings (type /settings or use tray)
2. Go to Preferences tab
3. Find the "Terminal" section with "Auto-paste to terminal" toggle
4. Toggle it OFF -- verify amber warning "Commands will not be pasted automatically" appears
5. Close settings, open overlay over a terminal
6. Type a safe query and press Enter
7. Verify: command does NOT auto-paste (it is only copied to clipboard)

**Test 4: Unsupported terminal fallback**
1. Open the overlay while a non-terminal app (e.g., Finder, browser) is in the foreground
2. Type a safe query and press Enter
3. Verify: no errors visible in the overlay; command is silently available in clipboard
4. Check console for "[store] auto-paste failed" log message (expected)

**Test 5: Toggle persistence**
1. Toggle auto-paste OFF in Settings > Preferences
2. Quit and relaunch the app
3. Open Settings > Preferences
4. Verify the auto-paste toggle is still OFF with warning label visible
  </action>
  <verify>All 5 test scenarios pass as described above.</verify>
  <done>Human confirms auto-paste works for safe commands, blocks for destructive commands, respects settings toggle, falls back silently for unsupported terminals, and persists preference across restarts.</done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes with zero errors
- Safe commands auto-paste to terminal input line without executing
- Destructive commands (flagged by Phase 5 safety layer) do NOT auto-paste
- When auto-paste is disabled in settings, no paste occurs for any command
- Clipboard always has the command as fallback regardless of paste success/failure
- Focus shifts to terminal after successful paste; overlay remains open
</verification>

<success_criteria>
- End-to-end auto-paste works for Terminal.app and/or iTerm2
- Destructive commands are blocked from auto-paste
- Settings toggle persists across app restarts
- Unsupported terminals silently fall back to clipboard
- Human verification confirms all 5 test scenarios pass
</success_criteria>

<output>
After completion, create `.planning/phases/06-terminal-pasting/06-02-SUMMARY.md`
</output>

---
phase: 04-ai-command-generation
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/store/index.ts
  - src/components/ResultsArea.tsx
  - src/components/CommandInput.tsx
  - src/components/Overlay.tsx
  - src/hooks/useKeyboard.ts
  - src/App.tsx
autonomous: true
requirements: [AICG-01, AICG-02]

must_haves:
  truths:
    - "User types a query and sees AI response stream token-by-token in monospace font"
    - "Input field transforms into output display area on submit"
    - "First Escape from result/streaming mode returns to input with previous query restored"
    - "Second Escape closes the overlay"
    - "Badge stays visible below the output area during and after streaming"
    - "Input is disabled while streaming is in progress"
    - "Follow-up queries replace previous response (not chat-style scroll)"
    - "Session turn history is maintained up to 7 turns and cleared on overlay close"
    - "Block cursor blinks at end of streaming text, disappears when complete"
    - "No API key shows inline error: No API key configured. Open Settings to add one."
    - "API errors shown in output area with muted/red styling"
    - "Overlay grows vertically to fit output, capped at 60vh with scroll"
    - "Auto-copy to clipboard when streaming completes"
    - "Click-to-copy on output area with Copied to clipboard indicator"
    - "Empty input submit shows brief shake animation"
    - "Placeholder text is Ask anything..."
  artifacts:
    - path: "src/store/index.ts"
      provides: "Streaming state fields, appendToken, submitQuery, session history"
      contains: "streamingText"
    - path: "src/components/ResultsArea.tsx"
      provides: "Streaming output renderer with block cursor, click-to-copy, error display"
      min_lines: 60
    - path: "src/components/CommandInput.tsx"
      provides: "Disabled-during-streaming input, shake animation, Ask anything... placeholder"
    - path: "src/hooks/useKeyboard.ts"
      provides: "Two-Escape state machine (result->input->close)"
  key_links:
    - from: "src/store/index.ts"
      to: "stream_ai_response"
      via: "invoke with Channel<string> onToken callback"
      pattern: "invoke.*stream_ai_response"
    - from: "src/components/ResultsArea.tsx"
      to: "src/store/index.ts"
      via: "useOverlayStore selectors for streamingText, displayMode, isStreaming"
      pattern: "useOverlayStore"
    - from: "src/hooks/useKeyboard.ts"
      to: "src/store/index.ts"
      via: "reads displayMode to decide Escape behavior"
      pattern: "displayMode"
---

<objective>
Wire the frontend to the Rust streaming backend: extend Zustand store with streaming state machine, transform ResultsArea into a token-by-token streaming output renderer, update CommandInput for streaming UX (disabled state, shake animation, placeholder), implement two-Escape keyboard behavior, and add auto-copy/click-to-copy clipboard integration.

Purpose: This delivers the complete end-to-end AI command generation experience -- from typing a query to seeing the streamed response appear character-by-character.

Output: Fully functional overlay that streams AI responses, handles input/output mode transitions, manages session history, and copies results to clipboard.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-ai-command-generation/04-CONTEXT.md
@.planning/phases/04-ai-command-generation/04-RESEARCH.md
@.planning/phases/04-ai-command-generation/04-01-SUMMARY.md
@src/store/index.ts
@src/components/ResultsArea.tsx
@src/components/CommandInput.tsx
@src/components/Overlay.tsx
@src/hooks/useKeyboard.ts
@src/App.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Zustand store with streaming state machine and submitQuery action</name>
  <files>
    src/store/index.ts
    src/App.tsx
  </files>
  <action>
**Add new state fields to OverlayState interface:**
```typescript
// Streaming state
streamingText: string;           // Accumulated response tokens
isStreaming: boolean;             // True while SSE in flight
displayMode: 'input' | 'streaming' | 'result';  // UI state machine
previousQuery: string;           // Saved for Escape-to-edit
turnHistory: { role: 'user' | 'assistant'; content: string }[];  // Session memory, max 7 turns (14 messages)
streamError: string | null;      // Error message to display in output area

// Actions
appendToken: (token: string) => void;
submitQuery: (query: string) => void;  // The main submit action that calls Rust
cancelStreaming: () => void;
returnToInput: () => void;       // Escape from result -> input
setStreamError: (error: string | null) => void;
```

**Initialize new fields in the store:**
```typescript
streamingText: '',
isStreaming: false,
displayMode: 'input',
previousQuery: '',
turnHistory: [],
streamError: null,
```

**Implement appendToken:**
```typescript
appendToken: (token) => set((state) => ({
  streamingText: state.streamingText + token,
})),
```

**Implement submitQuery:**
This is the core action. It:
1. Validates API key status (if `apiKeyStatus !== 'valid'`, set `streamError` to "No API key configured. Open Settings to add one." and set `displayMode: 'result'`).
2. Sets state: `isStreaming: true`, `displayMode: 'streaming'`, `streamingText: ''`, `streamError: null`, `previousQuery: query`, `submitted: true`, `showApiWarning: false`.
3. Creates a `Channel<string>` from `@tauri-apps/api/core`.
4. Sets `onmessage` to call `appendToken`.
5. Gets `selectedModel` from store state (fallback to `'grok-3'`).
6. Gets `appContext` from store state, serializes to JSON string for `context_json` parameter.
7. Gets `turnHistory` from store state for `history` parameter.
8. Calls `invoke('stream_ai_response', { query, model, contextJson, history, onToken })`.
9. On success (invoke resolves):
   - Set `isStreaming: false`, `displayMode: 'result'`.
   - Get the final `streamingText` from store.
   - Add to `turnHistory`: push `{role: 'user', content: query}` and `{role: 'assistant', content: streamingText}`. If history exceeds 14 messages (7 turns), trim the oldest turn (first 2 entries).
   - Auto-copy `streamingText` to clipboard via `navigator.clipboard.writeText()`.
10. On error (invoke rejects):
    - Set `isStreaming: false`, `displayMode: 'result'`, `streamError: errorMessage`.

Use `useOverlayStore.getState()` to read current state inside the async action (not closure stale state).

**Implement cancelStreaming:**
```typescript
cancelStreaming: () => set({
  isStreaming: false,
  displayMode: 'input',
  streamingText: '',
  streamError: null,
}),
```

**Implement returnToInput:**
```typescript
returnToInput: () => set((state) => ({
  displayMode: 'input',
  inputValue: state.previousQuery,
  streamingText: '',
  streamError: null,
  isStreaming: false,
})),
```

**Update show() action:** Add `turnHistory: []` to the reset fields (clear session on overlay open, per CONTEXT.md decision). Also add `streamingText: ''`, `isStreaming: false`, `displayMode: 'input'`, `previousQuery: ''`, `streamError: null`.

**Update App.tsx handleSubmit:**
Replace the current `submit()` call with `submitQuery(trimmed)`. Remove the old `submit()` import if no longer used. The `/settings` command check stays as-is. Add an empty-input shake: if `trimmed` is empty, the shake is handled by CommandInput (see Task 2).

**Important:** The `submit()` action in the store can be kept for backward compatibility but `handleSubmit` in App.tsx should now call `submitQuery` for actual AI queries. Keep `submit()` in the store interface but the main path is now `submitQuery`.
  </action>
  <verify>
TypeScript compilation: `cd src && npx tsc --noEmit` (or however the project checks types). The `invoke` call references `stream_ai_response` which exists in Rust from Plan 01. Verify no type errors.
  </verify>
  <done>
- Zustand store has streamingText, isStreaming, displayMode, previousQuery, turnHistory, streamError fields
- submitQuery action creates Channel, invokes stream_ai_response, handles success/error
- show() clears all streaming state and turnHistory on each overlay open
- appendToken, cancelStreaming, returnToInput actions work correctly
- App.tsx handleSubmit calls submitQuery instead of submit
  </done>
</task>

<task type="auto">
  <name>Task 2: Rewrite ResultsArea, update CommandInput, update useKeyboard, update Overlay</name>
  <files>
    src/components/ResultsArea.tsx
    src/components/CommandInput.tsx
    src/hooks/useKeyboard.ts
    src/components/Overlay.tsx
  </files>
  <action>
**ResultsArea.tsx -- Complete rewrite:**

Replace the placeholder component with a streaming output renderer:

1. Read from store: `streamingText`, `isStreaming`, `displayMode`, `streamError`.
2. Only render when `displayMode === 'streaming' || displayMode === 'result'`.
3. Layout:
   - Container div: `border-t border-white/10 pt-3 mt-1`
   - Scrollable content area: `max-h-[60vh] overflow-y-auto`
   - Monospace text: `font-mono text-sm text-white/90 whitespace-pre-wrap break-words`
4. If `streamError`:
   - Show error text in `text-red-400/70 text-xs font-mono` styling.
   - If error contains "API key", add a clickable "Open Settings" link (reuse existing pattern from current ResultsArea).
5. If no error, show `streamingText`:
   - Render in a `<pre>` tag with monospace styling.
   - Block cursor: Append a blinking block cursor character ONLY while `isStreaming === true`.
     ```tsx
     {isStreaming && (
       <span className="inline-block w-[0.6em] h-[1.1em] bg-white/80 animate-pulse align-text-bottom ml-px" />
     )}
     ```
   - The block cursor disappears when streaming completes (`isStreaming` becomes false).
6. Click-to-copy:
   - The output area has `cursor-pointer` class.
   - Subtle hover effect: `hover:bg-white/5 transition-colors rounded`
   - On click: `navigator.clipboard.writeText(streamingText)` and show a "Copied to clipboard" indicator.
   - The indicator: a small absolute-positioned text at bottom-right of the output area, `text-[10px] text-white/50`, shown for 1.5 seconds using a local `useState<boolean>` (`copiedVisible`).
   - Only show click-to-copy behavior when `displayMode === 'result'` (not during streaming).

**CommandInput.tsx -- Updates:**

1. **Disable during streaming:** Read `isStreaming` and `displayMode` from store. When `displayMode !== 'input'`, hide the CommandInput entirely (return null). The input only shows in `input` mode.
   - Actually, per CONTEXT.md: "Input field transforms into output display on submit. Same area, different content." So CommandInput renders when `displayMode === 'input'`, and ResultsArea renders when `displayMode === 'streaming' || displayMode === 'result'`. They alternate in the same slot.
2. **Shake animation on empty submit:** Add a `shaking` state. When `handleKeyDown` Enter is pressed and `inputValue.trim()` is empty, set `shaking: true`, then setTimeout to false after 300ms. Add CSS class `animate-[shake_0.3s_ease-in-out]` to the container div when shaking. Define the shake keyframe in the component or in App.css:
   ```css
   @keyframes shake {
     0%, 100% { transform: translateX(0); }
     25% { transform: translateX(-4px); }
     75% { transform: translateX(4px); }
   }
   ```
3. **Placeholder text:** Change from "Describe a task or type a command..." to "Ask anything..."

**useKeyboard.ts -- Two-Escape state machine:**

Update the Escape handler to read `displayMode` from the store:
```typescript
const handleKeyDown = (e: KeyboardEvent) => {
  if (e.key === 'Escape') {
    const state = useOverlayStore.getState();
    if (state.displayMode === 'streaming') {
      // During streaming: cancel and return to input
      state.cancelStreaming();
    } else if (state.displayMode === 'result') {
      // In result mode: return to input with previous query
      state.returnToInput();
    } else {
      // In input mode: close the overlay
      invoke('hide_overlay').catch(console.error);
      state.hide();
    }
  }
};
```

This implements the two-Escape flow: result -> input (first press) -> close (second press).

**Overlay.tsx -- Conditional rendering:**

Update the command mode section to conditionally render CommandInput or ResultsArea based on `displayMode`:

Read `displayMode` from store. In the command mode block:
- When `displayMode === 'input'`: render `<CommandInput onSubmit={onSubmit} />`
- When `displayMode === 'streaming' || displayMode === 'result'`: render `<ResultsArea />`
- The badge area stays visible in ALL display modes (below both input and output).
- Remove the current `<ResultsArea />` that sits after the badge area -- it now takes CommandInput's slot.

The structure should be:
```tsx
{hotkeyConfigOpen ? (
  <HotkeyConfig />
) : (
  <>
    {displayMode === 'input' ? (
      <CommandInput onSubmit={onSubmit} />
    ) : (
      <ResultsArea />
    )}
    {mode === 'command' && (
      <div className="flex items-center gap-2 min-h-[20px]">
        {/* badge spinner/text -- unchanged */}
      </div>
    )}
  </>
)}
```

**Important implementation notes:**
- Do NOT re-detect app context on follow-up queries. Context is captured once in `show()` and reused.
- The `onSubmit` prop on Overlay can now just call `submitQuery` directly. Adjust App.tsx if needed so `handleSubmit` calls `store.submitQuery(trimmed)`.
- The CommandInput's own `onSubmit` prop is still used for the Enter key path.
  </action>
  <verify>
1. `npx tsc --noEmit` from project root -- zero TypeScript errors.
2. Visual check (manual, not automated): Run `npm run tauri dev` and verify:
   - Type a query, press Enter, see streaming output appear
   - Block cursor blinks during streaming
   - Escape returns to input with previous query
   - Second Escape closes overlay
   - Badge visible below output
   - Click output area to re-copy
  </verify>
  <done>
- ResultsArea renders streaming text with monospace font and block cursor
- Click-to-copy with "Copied to clipboard" indicator works
- Error messages displayed with red/muted styling
- CommandInput shows shake on empty submit, placeholder is "Ask anything..."
- Input and output alternate in the same slot based on displayMode
- useKeyboard implements result -> input -> close Escape flow
- Badge visible in all display modes
- Overlay grows vertically with 60vh cap and scroll
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` -- zero TypeScript compilation errors
2. Full flow test: open overlay over a terminal, type "list all files", press Enter. Tokens should stream in monospace. Block cursor blinks during streaming and disappears after.
3. Escape test: press Escape once (returns to input with "list all files" restored). Press Escape again (overlay closes).
4. Error test: delete API key, try submitting -- "No API key configured" error shown inline.
5. Clipboard test: after streaming completes, text is auto-copied. Click output area -- "Copied to clipboard" appears.
6. Badge test: badge (e.g., "zsh") visible below output area throughout.
7. Empty submit test: press Enter with empty input -- input shakes briefly.
</verification>

<success_criteria>
- Token-by-token streaming from xAI renders in real-time in the overlay
- Two-mode display: terminal commands in command-only format, assistant mode for non-terminal apps
- Input <-> Output mode transitions work via Escape
- Session history maintained for up to 7 turns within one overlay session
- Auto-copy to clipboard on stream completion
- Click-to-copy with visual feedback
- Error states handled gracefully with inline messages
- Overlay height adapts to content with 60vh scroll cap
</success_criteria>

<output>
After completion, create `.planning/phases/04-ai-command-generation/04-02-SUMMARY.md`
</output>

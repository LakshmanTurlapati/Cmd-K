---
phase: 10-ai-follow-up-context-per-window
plan: 02
type: execute
wave: 2
depends_on: [10-01]
files_modified:
  - src/components/Settings/PreferencesTab.tsx
  - src/App.tsx
  - src-tauri/src/commands/history.rs
  - src-tauri/src/commands/mod.rs
  - src-tauri/src/lib.rs
autonomous: true
requirements: [CTXT-01]

must_haves:
  truths:
    - "User can adjust the AI conversation memory depth via a slider in Preferences (range 5-50, default 7)"
    - "Turn limit preference persists across app restarts via settings.json"
    - "User can clear all conversation history for all windows via a button in Preferences"
    - "After clearing history, the AI starts fresh with no prior context on any window"
  artifacts:
    - path: "src/components/Settings/PreferencesTab.tsx"
      provides: "Turn limit slider (5-50), clear conversation history button"
      contains: "turnLimit"
    - path: "src/App.tsx"
      provides: "turnLimit loaded from settings.json on startup"
      contains: "turnLimit"
    - path: "src-tauri/src/commands/history.rs"
      provides: "clear_all_history IPC command"
      contains: "clear_all_history"
    - path: "src-tauri/src/lib.rs"
      provides: "clear_all_history registered in invoke_handler"
      contains: "clear_all_history"
  key_links:
    - from: "src/components/Settings/PreferencesTab.tsx"
      to: "useOverlayStore.setTurnLimit"
      via: "slider onChange handler"
      pattern: "setTurnLimit"
    - from: "src/components/Settings/PreferencesTab.tsx"
      to: "clear_all_history IPC"
      via: "button onClick -> invoke('clear_all_history')"
      pattern: "clear_all_history"
    - from: "src/App.tsx"
      to: "settings.json"
      via: "store.get('turnLimit') on startup"
      pattern: "turnLimit"
---

<objective>
Add turn limit slider and clear conversation history button to the Preferences settings tab, with Rust-side clear_all_history IPC command and startup persistence loading.

Purpose: Users need control over how much conversation context the AI remembers (configurable turn limit) and the ability to wipe all history (per user decision: "Clear conversation history" button that clears all windows at once).

Output: Updated PreferencesTab with slider + button, new Rust IPC command, startup preference loading.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-follow-up-context-per-window/10-RESEARCH.md
@.planning/phases/10-ai-follow-up-context-per-window/10-01-SUMMARY.md

Key source files:
@src/components/Settings/PreferencesTab.tsx
@src/components/Settings/AdvancedTab.tsx (reference for toggle pattern)
@src/App.tsx
@src-tauri/src/commands/history.rs
@src-tauri/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Turn limit slider and clear history button in PreferencesTab</name>
  <files>src/components/Settings/PreferencesTab.tsx, src/App.tsx</files>
  <action>
**1. Update PreferencesTab.tsx to include turn limit slider and clear history button:**

Add imports at the top:
```typescript
import { Store } from "@tauri-apps/plugin-store";
import { invoke } from "@tauri-apps/api/core";
import { useOverlayStore } from "@/store";
import { Trash2 } from "lucide-react";
```

Add Zustand state hooks inside the component:
```typescript
const turnLimit = useOverlayStore((state) => state.turnLimit);
const setTurnLimit = useOverlayStore((state) => state.setTurnLimit);
```

Add handler functions:
```typescript
const handleTurnLimitChange = async (value: number) => {
  setTurnLimit(value);
  try {
    const store = await Store.load("settings.json");
    await store.set("turnLimit", value);
    await store.save();
  } catch (err) {
    console.error("[preferences] Failed to persist turnLimit:", err);
  }
};

const handleClearHistory = async () => {
  try {
    await invoke("clear_all_history");
    // Reset frontend state
    useOverlayStore.getState().setWindowHistory([]);
    useOverlayStore.getState().setTurnHistory([]);
  } catch (err) {
    console.error("[preferences] Failed to clear history:", err);
  }
};
```

Add the following sections to the JSX, after the existing Keyboard Shortcut section:

```tsx
{/* AI Memory section */}
<p className="text-white/40 text-xs uppercase tracking-wider mt-3">
  AI Memory
</p>
<div className="flex flex-col gap-2">
  <div className="flex items-center justify-between">
    <span className="text-white/70 text-xs">Conversation memory</span>
    <span className="text-white/40 text-xs font-mono">{turnLimit} turns</span>
  </div>
  <input
    type="range"
    min={5}
    max={50}
    value={turnLimit}
    onChange={(e) => handleTurnLimitChange(Number(e.target.value))}
    className="w-full accent-blue-500 h-1"
  />
  <p className="text-white/30 text-xs">
    How many prior exchanges the AI remembers per window
  </p>
</div>

{/* Clear history section */}
<div className="mt-1">
  <button
    type="button"
    onClick={handleClearHistory}
    className="flex items-center gap-2 text-white/60 hover:text-red-400/80 text-xs transition-colors cursor-default bg-transparent border-none p-0"
  >
    <Trash2 size={12} />
    Clear conversation history
  </button>
  <p className="text-white/30 text-xs mt-1">
    Clears all AI context and command history for all windows
  </p>
</div>
```

**2. Load turnLimit from settings.json on startup in App.tsx:**

In the `checkOnboarding` function in App.tsx, in BOTH branches (onboarding not complete AND onboarding complete), add after the existing auto-paste preference loading:

```typescript
// Load persisted turn limit preference
const turnLimitValue = await store.get<number>("turnLimit");
useOverlayStore.getState().setTurnLimit(turnLimitValue ?? 7);
```

This ensures the turnLimit is loaded from disk on every app startup, matching the pattern used for destructiveDetectionEnabled and autoPasteEnabled.
  </action>
  <verify>
Run `cd src && npx tsc --noEmit` (or project TS check) to verify TypeScript compiles.
Grep for `turnLimit` in PreferencesTab.tsx -- should appear in slider value, onChange handler, and store hook.
Grep for `clear_all_history` in PreferencesTab.tsx -- should appear in handleClearHistory.
Grep for `turnLimit` in App.tsx -- should appear in both branches of checkOnboarding.
  </verify>
  <done>
PreferencesTab shows a turn limit slider (5-50, default 7) that persists to settings.json, and a "Clear conversation history" button. App.tsx loads the persisted turnLimit on startup.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rust clear_all_history IPC command and registration</name>
  <files>src-tauri/src/commands/history.rs, src-tauri/src/lib.rs</files>
  <action>
**1. Add clear_all_history command to history.rs:**

Add the following function at the end of history.rs:

```rust
/// Clears all per-window history entries from AppState.
///
/// This wipes both AI conversation context and arrow-key command recall
/// data for every tracked window. Called from the "Clear conversation history"
/// button in Preferences.
#[tauri::command]
pub fn clear_all_history(app: tauri::AppHandle) -> Result<(), String> {
    use tauri::Manager;
    let state = app
        .try_state::<crate::state::AppState>()
        .ok_or("AppState not found")?;
    let mut history = state
        .history
        .lock()
        .map_err(|_| "History mutex poisoned".to_string())?;
    let window_count = history.len();
    history.clear();
    eprintln!("[history] cleared all history ({} windows)", window_count);
    Ok(())
}
```

**2. Import and register clear_all_history in lib.rs:**

In the `use commands::history::{...}` import at the top of lib.rs, add `clear_all_history`:
```rust
use commands::{
    history::{get_window_key, get_window_history, add_history_entry, clear_all_history},
    // ... rest unchanged
};
```

In the `invoke_handler` `generate_handler!` macro, add `clear_all_history` after `add_history_entry`:
```rust
.invoke_handler(tauri::generate_handler![
    // ... existing commands ...
    add_history_entry,
    clear_all_history,
])
```
  </action>
  <verify>
Run `cd src-tauri && cargo check` to verify Rust compiles with zero errors.
Grep for `clear_all_history` in history.rs -- should appear as a `#[tauri::command]` function.
Grep for `clear_all_history` in lib.rs -- should appear in both the use statement and generate_handler.
  </verify>
  <done>
clear_all_history IPC command exists in history.rs, clears all per-window history from AppState HashMap, and is registered in lib.rs invoke_handler.
  </done>
</task>

</tasks>

<verification>
1. `cargo check` passes in src-tauri/ with zero errors
2. TypeScript compilation passes with zero errors
3. PreferencesTab renders: keyboard shortcut section + AI Memory slider + Clear history button
4. Turn limit slider range is 5-50, default 7
5. Changing slider persists value to settings.json
6. App.tsx loads turnLimit on startup in both onboarding branches
7. clear_all_history IPC is callable from frontend
8. Clear button resets both windowHistory and turnHistory in Zustand
</verification>

<success_criteria>
- Turn limit slider visible in Preferences, persists across restarts (CTXT-01 -- configurable memory)
- Clear conversation history button wipes all windows' history (CTXT-01 -- per user decision)
- Settings UI follows existing project patterns (toggle style from AdvancedTab, Store persistence from App.tsx)
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-follow-up-context-per-window/10-02-SUMMARY.md`
</output>

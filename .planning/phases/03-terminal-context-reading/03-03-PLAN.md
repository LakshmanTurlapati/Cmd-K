---
phase: 03-terminal-context-reading
plan: 03
type: execute
wave: 3
depends_on: ["03-02"]
files_modified:
  - src/store/index.ts
  - src/components/Overlay.tsx
  - src-tauri/capabilities/default.json
autonomous: false
requirements: [TERM-02, TERM-03, TERM-04]

must_haves:
  truths:
    - "When overlay opens over a terminal, shell type label (e.g., 'zsh') appears below the input field"
    - "When overlay opens over a non-terminal app, context area is completely hidden"
    - "When Accessibility permission is denied, persistent non-dismissable banner says 'Enable Accessibility for terminal context' with clickable link to System Settings"
    - "Banner disappears once Accessibility permission is granted (re-checked each overlay open)"
    - "Subtle spinner is shown during context detection; hidden after detection completes or times out"
    - "Overlay height adjusts: slightly taller with shell type shown, shorter without"
    - "CWD, visible output, running process are stored in Zustand but NOT displayed in overlay"
    - "AI works regardless of whether context was captured"
  artifacts:
    - path: "src/store/index.ts"
      provides: "Terminal context state in Zustand store"
      contains: "terminalContext"
    - path: "src/components/Overlay.tsx"
      provides: "Context-aware overlay with shell label, spinner, accessibility banner"
      contains: "shellType"
  key_links:
    - from: "src/components/Overlay.tsx"
      to: "src/store/index.ts"
      via: "useOverlayStore selectors for terminalContext and accessibilityPermission"
      pattern: "useOverlayStore"
    - from: "src/store/index.ts"
      to: "get_terminal_context"
      via: "invoke('get_terminal_context') called when overlay shown"
      pattern: "invoke.*get_terminal_context"
    - from: "src/store/index.ts"
      to: "check_accessibility_permission"
      via: "invoke('check_accessibility_permission') called each overlay show"
      pattern: "invoke.*check_accessibility_permission"
---

<objective>
Frontend overlay integration: detect terminal context on overlay show, display shell type label, show accessibility permission banner when needed, and verify complete Phase 3 experience.

Purpose: Connect the Rust detection backend to the user-facing overlay. The shell type label provides the only visible signal that context was captured. The accessibility banner ensures users know when to grant permission. The checkpoint verifies the full end-to-end experience across all terminals.

Output: Updated Zustand store with terminal context state, updated Overlay.tsx with shell label + spinner + banner, human verification of complete Phase 3 experience.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-terminal-context-reading/03-RESEARCH.md
@.planning/phases/03-terminal-context-reading/03-01-SUMMARY.md
@.planning/phases/03-terminal-context-reading/03-02-SUMMARY.md
@.planning/phases/02-settings-configuration/02-03-SUMMARY.md

Key files:
@src/store/index.ts (Zustand store -- add terminal context state)
@src/components/Overlay.tsx (shell type label, spinner, banner)
@src/components/CommandInput.tsx (context passed to AI in Phase 4)
@src-tauri/capabilities/default.json (allow get_terminal_context IPC)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Zustand store with terminal context, wire detection on overlay show, update Overlay UI</name>
  <files>
    src/store/index.ts
    src/components/Overlay.tsx
    src/components/CommandInput.tsx
    src-tauri/capabilities/default.json
  </files>
  <action>
    **capabilities/default.json:** Ensure `get_terminal_context` IPC command is allowed. Follow the existing pattern for other commands (check how `show_overlay`, `check_accessibility_permission` are listed and add `get_terminal_context` in the same format).

    **store/index.ts:** Add terminal context state and detection logic:

    1. Add new interface and state fields:
    ```typescript
    interface TerminalContext {
      shell_type: string | null;
      cwd: string | null;
      visible_output: string | null;
      running_process: string | null;
    }

    // In OverlayState interface, add:
    terminalContext: TerminalContext | null;
    isDetectingContext: boolean;
    accessibilityGranted: boolean;

    // Actions:
    setTerminalContext: (ctx: TerminalContext | null) => void;
    setIsDetectingContext: (detecting: boolean) => void;
    setAccessibilityGranted: (granted: boolean) => void;
    ```

    2. Initialize in create():
    ```typescript
    terminalContext: null,
    isDetectingContext: false,
    accessibilityGranted: false,
    ```

    3. Add action implementations:
    ```typescript
    setTerminalContext: (ctx) => set({ terminalContext: ctx }),
    setIsDetectingContext: (detecting) => set({ isDetectingContext: detecting }),
    setAccessibilityGranted: (granted) => set({ accessibilityGranted: granted }),
    ```

    4. Update the `show` action to trigger context detection:
    ```typescript
    show: () => {
      set((state) => ({
        visible: true,
        mode: state.mode === "onboarding" && !state.onboardingComplete ? "onboarding" : "command",
        hotkeyConfigOpen: false,
        inputValue: "",
        submitted: false,
        showApiWarning: false,
        terminalContext: null,       // Reset context on each show
        isDetectingContext: true,    // Start spinner
      }));

      // Fire-and-forget context detection (non-blocking)
      // This runs after state update, so the overlay appears immediately
      (async () => {
        try {
          const { invoke } = await import("@tauri-apps/api/core");

          // Check accessibility permission each time
          const hasPermission = await invoke<boolean>("check_accessibility_permission");
          useOverlayStore.getState().setAccessibilityGranted(hasPermission);

          // Detect terminal context
          const ctx = await invoke<TerminalContext | null>("get_terminal_context");
          useOverlayStore.getState().setTerminalContext(ctx);
        } catch {
          // Silent failure -- AI works without context
        } finally {
          useOverlayStore.getState().setIsDetectingContext(false);
        }
      })();
    },
    ```

    IMPORTANT: The detection MUST NOT block the overlay from appearing. The async IIFE fires after the synchronous state update, so the overlay renders immediately with a spinner, then updates when detection completes.

    **Overlay.tsx:** Add shell type label, accessibility banner, and spinner:

    1. Import additional store selectors:
    ```typescript
    const terminalContext = useOverlayStore((s) => s.terminalContext);
    const isDetecting = useOverlayStore((s) => s.isDetectingContext);
    const accessibilityGranted = useOverlayStore((s) => s.accessibilityGranted);
    const mode = useOverlayStore((s) => s.mode);
    ```

    2. Add an accessibility banner component (shown ONLY in command mode when permission is denied):
    ```tsx
    {mode === "command" && !accessibilityGranted && (
      <div
        className="flex items-center gap-2 px-3 py-2 bg-amber-900/40 border border-amber-500/30 rounded-lg text-xs text-amber-200 cursor-pointer"
        onClick={async () => {
          const { invoke } = await import("@tauri-apps/api/core");
          invoke("open_accessibility_settings");
        }}
      >
        <span>Enable Accessibility for terminal context</span>
      </div>
    )}
    ```
    Place this banner at the TOP of the command mode content (above CommandInput). It is persistent (not dismissable) and disappears once permission is granted (re-checked each show).

    3. Add a shell type label area below the CommandInput (in command mode only):
    ```tsx
    {mode === "command" && (
      <div className="flex items-center gap-2 min-h-[20px]">
        {isDetecting ? (
          <div className="w-3 h-3 border border-white/30 border-t-white/70 rounded-full animate-spin" />
        ) : terminalContext?.shell_type ? (
          <span className="text-[11px] text-white/40 font-mono">{terminalContext.shell_type}</span>
        ) : null}
      </div>
    )}
    ```

    The layout:
    - If detecting: show tiny spinner
    - If detected and shell_type exists: show "zsh" (or "bash", "fish", etc.) in subtle monospace text
    - If detected but no terminal (null context): hide entirely (min-h-[20px] collapses)
    - If detection failed/timed out: hide entirely

    Per CONTEXT.md decisions:
    - Shell type label appears to the LEFT (flex items-center gap-2)
    - CWD, terminal output, running process are NOT displayed (stored in state for Phase 4 AI use)
    - When no context available, hide the context area completely -- no placeholder
    - Overlay height adjusts naturally since the shell label div is conditional

    4. The panelWidth already adjusts by mode. For command mode with context, the default w-[320px] is sufficient since we are only adding a small shell type label.

    **CommandInput.tsx:** No visual changes needed. The terminal context is stored in Zustand and will be passed to the AI in Phase 4. For now, just ensure the store import pattern is compatible if someone needs to read `terminalContext` later:
    - No code changes needed in this file for this plan. Just listed for awareness that Phase 4 will read `terminalContext` from the store here.
    - ACTUALLY: remove CommandInput.tsx from the action since no changes are needed. But keep it in files_modified for the plan metadata to signal that Phase 4 will touch it.

    Wait -- the plan says files_modified should list files this plan touches. If CommandInput.tsx is NOT modified, remove it. Let me correct: only modify store/index.ts, Overlay.tsx, and capabilities/default.json.
  </action>
  <verify>
    Run `cd src-tauri && cargo check` (ensure capabilities are valid).
    Run `npm run build` or `npx tsc --noEmit` to verify TypeScript compiles.
    Verify store has terminal context: `grep "terminalContext\|isDetectingContext\|accessibilityGranted" src/store/index.ts`.
    Verify overlay has shell label: `grep "shell_type\|shellType" src/components/Overlay.tsx`.
    Verify accessibility banner: `grep "Enable Accessibility" src/components/Overlay.tsx`.
    Verify spinner: `grep "animate-spin\|isDetecting" src/components/Overlay.tsx`.
    Verify get_terminal_context is invoked: `grep "get_terminal_context" src/store/index.ts`.
    Verify check_accessibility_permission is called on show: `grep "check_accessibility_permission" src/store/index.ts`.
  </verify>
  <done>
    Zustand store extended with terminalContext, isDetectingContext, accessibilityGranted. Detection fires async on overlay show (non-blocking). Accessibility permission re-checked each open. Overlay shows: (1) persistent amber accessibility banner when permission denied, (2) subtle spinner during detection, (3) shell type label (e.g., "zsh") when detected, (4) nothing when no terminal context. CWD/output/process stored in state for Phase 4. TypeScript and Rust compile.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 3 terminal context reading experience</name>
  <files>none</files>
  <action>
    Human verification of the complete Phase 3 terminal context detection pipeline:
    - Rust backend reads CWD, shell type, visible output, and running process from the frontmost terminal
    - Frontend shows shell type label and handles accessibility permission
    - Full pipeline with 500ms timeout

    Run `pnpm tauri dev` from the project root and verify the following:

    **Test 1: Terminal.app Detection**
    1. Open Terminal.app and cd to a project directory
    2. Press Cmd+Shift+K (or your configured hotkey)
    3. Verify: overlay appears with "zsh" (or your shell) label below the input field
    4. Verify: small spinner appears briefly during detection, then shell type label appears

    **Test 2: iTerm2 Detection**
    5. Switch to iTerm2 (if installed)
    6. Press Cmd+Shift+K
    7. Verify: shell type label appears correctly

    **Test 3: Non-Terminal App**
    8. Switch to a non-terminal app (Finder, browser)
    9. Press Cmd+Shift+K
    10. Verify: overlay appears with NO shell type label, NO context area, NO placeholder text

    **Test 4: Accessibility Permission Banner**
    11. If Accessibility permission was revoked: overlay should show amber "Enable Accessibility for terminal context" banner
    12. Click the banner -- verify it opens System Settings to Accessibility
    13. Grant permission if needed
    14. Press Cmd+Shift+K again -- banner should be gone

    **Test 5: Detection Timeout**
    15. Verify overlay appears within ~500ms even when detection is slow
    16. Verify overlay is never stuck or frozen

    **Test 6: tmux (if available)**
    17. Start tmux in a terminal
    18. cd to a directory inside tmux
    19. Press Cmd+Shift+K
    20. Verify: shell type label appears (detection worked through tmux)

    **Test 7: Sensitive Data Not Leaked (developer test)**
    21. In terminal, run: echo "xai-abcdefghijklmnopqrstuvwxyz123456"
    22. Press Cmd+Shift+K
    23. Check developer console (or internal state via React DevTools): visible_output should contain [REDACTED] instead of the token

    **Test 8: AI Still Works Without Context**
    24. Open overlay from a non-terminal app
    25. Type any command query and submit
    26. Verify: "API not configured" message appears (Phase 4 replacement) -- overlay functions normally without context
  </action>
  <verify>
    All 8 test categories pass. Shell type label visible over Terminal.app/iTerm2. No context shown over non-terminal apps. Accessibility banner works. Detection does not stall overlay.
  </verify>
  <done>
    Human has verified: terminal context detection works for Terminal.app and iTerm2 (shell type label shown), non-terminal apps show no context, accessibility banner functions correctly, sensitive data is redacted, detection completes within timeout, and overlay functions normally without context.
  </done>
</task>

</tasks>

<verification>
1. Overlay shows shell type label when opened from a terminal
2. No context area shown when opened from non-terminal app
3. Accessibility banner visible when permission denied, hidden when granted
4. Spinner during detection, label after
5. Detection completes within 500ms
6. CWD, visible output, running process captured in Zustand state (developer verification)
7. Sensitive data redacted in captured output
8. Overlay works normally without terminal context
</verification>

<success_criteria>
- Shell type (zsh/bash/fish) displayed as subtle label below overlay input
- Accessibility permission banner works correctly (show/hide/click)
- Detection is non-blocking (overlay appears instantly, context fills in)
- Non-terminal apps produce no context area
- Human verification passes all 8 test categories
</success_criteria>

<output>
After completion, create `.planning/phases/03-terminal-context-reading/03-03-SUMMARY.md`
</output>

---
phase: 03-terminal-context-reading
plan: 05
type: execute
wave: 4
depends_on: ["03-03", "03-04"]
files_modified:
  - src/store/index.ts
  - src/components/Overlay.tsx
  - src-tauri/capabilities/default.json
autonomous: false
requirements: [TERM-02, TERM-03, TERM-04]

must_haves:
  truths:
    - "Badge displays shell type (e.g., 'zsh') when frontmost app has a detected shell -- highest priority"
    - "Badge displays 'Console' when browser has DevTools open and no shell detected -- second priority"
    - "Badge displays cleaned app name (e.g., 'Chrome', 'Finder') when no shell and no console -- third priority"
    - "Shell badge shown for integrated terminals: when zsh detected in Cursor, badge shows 'zsh' not 'Cursor'"
    - "Chromium-based browsers (Arc, Edge, Brave) show their own name badge, not 'Chrome'"
    - "Console last line stored in Zustand for AI context (Phase 4) but NOT displayed in overlay"
    - "App name stored in Zustand for AI context (Phase 4) but NOT displayed in overlay -- only used for badge resolution"
    - "Spinner shown during detection, badge appears after detection completes"
    - "When detection fails or times out, badge area hidden entirely"
    - "Accessibility banner still works: shown when permission denied, hidden when granted"
    - "Human verification confirms badge behavior across terminal, browser, and generic app scenarios"
  artifacts:
    - path: "src/store/index.ts"
      provides: "AppContext type replacing TerminalContext in store, badge resolution logic"
      contains: "AppContext"
    - path: "src/components/Overlay.tsx"
      provides: "Badge display with priority: shell > console > app name"
      contains: "badgeText"
  key_links:
    - from: "src/store/index.ts"
      to: "get_app_context"
      via: "invoke('get_app_context') replacing get_terminal_context on overlay show"
      pattern: "invoke.*get_app_context"
    - from: "src/components/Overlay.tsx"
      to: "src/store/index.ts"
      via: "useOverlayStore selectors for appContext and badge resolution"
      pattern: "useOverlayStore"
---

<objective>
Update the frontend to use the new AppContext IPC response and implement the badge priority system: shell type > console > app name.

Purpose: Connect the expanded Rust detection backend (Plan 03-04) to the user-facing overlay. Every frontmost app now gets a badge -- terminals show shell type, browsers with DevTools show "Console", and all other apps show their cleaned display name. This completes the user-facing context awareness features specified in the updated CONTEXT.md.

Output: Updated Zustand store with AppContext type, updated Overlay.tsx with badge priority system, human verification of all badge scenarios.
</objective>

<execution_context>
@/Users/lakshmanturlapati/.claude/get-shit-done/workflows/execute-plan.md
@/Users/lakshmanturlapati/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-terminal-context-reading/03-CONTEXT.md
@.planning/phases/03-terminal-context-reading/03-03-SUMMARY.md
@.planning/phases/03-terminal-context-reading/03-04-SUMMARY.md

Key files:
@src/store/index.ts (Zustand store with TerminalContext -- update to AppContext)
@src/components/Overlay.tsx (Badge display area -- update to badge priority system)
@src-tauri/capabilities/default.json (ensure get_app_context is allowed)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update Zustand store to use AppContext and implement badge priority, update Overlay badge display</name>
  <files>
    src/store/index.ts
    src/components/Overlay.tsx
    src-tauri/capabilities/default.json
  </files>
  <action>
    **capabilities/default.json:** Ensure `get_app_context` IPC command is allowed. Follow the existing pattern for how other commands are listed and add it.

    **store/index.ts:** Replace TerminalContext with AppContext.

    1. Add new AppContext interface:
    ```typescript
    export interface AppContext {
      app_name: string | null;
      terminal: TerminalContext | null;
      console_detected: boolean;
      console_last_line: string | null;
    }
    ```
    Keep TerminalContext interface as-is (it is nested inside AppContext).

    2. Update OverlayState interface:
    - Change `terminalContext: TerminalContext | null` to `appContext: AppContext | null`
    - Add `setAppContext: (ctx: AppContext | null) => void`
    - Keep `setTerminalContext` as a compatibility alias if needed, or remove and update all references

    3. Update the `show` action to call `get_app_context` instead of `get_terminal_context`:
    ```typescript
    show: () => {
      set((state) => ({
        visible: true,
        mode: state.mode === "onboarding" && !state.onboardingComplete ? "onboarding" : "command",
        hotkeyConfigOpen: false,
        inputValue: "",
        submitted: false,
        showApiWarning: false,
        appContext: null,         // Reset on each show
        isDetectingContext: true, // Start spinner
      }));

      (async () => {
        try {
          const { invoke } = await import("@tauri-apps/api/core");

          const hasPermission = await invoke<boolean>("check_accessibility_permission");
          useOverlayStore.getState().setAccessibilityGranted(hasPermission);

          // Use new get_app_context (returns AppContext for ALL apps)
          const ctx = await invoke<AppContext | null>("get_app_context");
          console.log("[store] app context:", JSON.stringify(ctx));
          useOverlayStore.getState().setAppContext(ctx);
        } catch (err) {
          console.error("[store] context detection error:", err);
        } finally {
          useOverlayStore.getState().setIsDetectingContext(false);
        }
      })();
    },
    ```

    4. Add badge resolution helper (pure function, can be outside the store or as a derived value):
    ```typescript
    /** Resolve the badge text from AppContext using priority: shell > console > app name */
    export function resolveBadge(ctx: AppContext | null): string | null {
      if (!ctx) return null;

      // Priority 1: Shell type (from terminal or editor integrated terminal)
      if (ctx.terminal?.shell_type) {
        return ctx.terminal.shell_type;
      }

      // Priority 2: Console (browser has DevTools open)
      if (ctx.console_detected) {
        return "Console";
      }

      // Priority 3: App name
      if (ctx.app_name) {
        return ctx.app_name;
      }

      return null;
    }
    ```

    **Overlay.tsx:** Update the badge display area.

    1. Update store selectors:
    ```typescript
    const appContext = useOverlayStore((s) => s.appContext);
    const isDetecting = useOverlayStore((s) => s.isDetectingContext);
    const accessibilityGranted = useOverlayStore((s) => s.accessibilityGranted);
    const mode = useOverlayStore((s) => s.mode);
    ```

    2. Compute badge text using the resolver:
    ```typescript
    import { resolveBadge } from "../store";
    const badgeText = resolveBadge(appContext);
    ```

    3. Replace the shell type label area with the badge priority display:
    ```tsx
    {mode === "command" && (
      <div className="flex items-center gap-2 min-h-[20px]">
        {isDetecting ? (
          <div className="w-3 h-3 border border-white/30 border-t-white/70 rounded-full animate-spin" />
        ) : badgeText ? (
          <span className="text-[11px] text-white/40 font-mono">{badgeText}</span>
        ) : null}
      </div>
    )}
    ```

    The badge area works exactly the same visually as Plan 03-03's shell label, but now it shows:
    - "zsh", "bash", "fish" for terminals and editors with integrated terminals
    - "Console" for browsers with DevTools open
    - "Chrome", "Safari", "Finder", "Figma" etc. for other apps
    - Nothing (hidden) when detection fails or times out

    Per CONTEXT.md locked decisions:
    - CWD, visible output, running process, console last line are stored in Zustand but NOT displayed
    - Only the badge text (shell/console/app name) is shown to the user
    - Spinner during detection, badge after, hidden on failure
    - The accessibility banner remains unchanged from Plan 03-03
  </action>
  <verify>
    Run `npx tsc --noEmit` or `npm run build` to verify TypeScript compiles.
    Verify AppContext type: `grep "interface AppContext" src/store/index.ts`.
    Verify get_app_context invocation: `grep "get_app_context" src/store/index.ts`.
    Verify resolveBadge function: `grep "resolveBadge" src/store/index.ts`.
    Verify badge in overlay: `grep "badgeText\|resolveBadge" src/components/Overlay.tsx`.
    Verify spinner still present: `grep "animate-spin" src/components/Overlay.tsx`.
    Verify accessibility banner: `grep "Enable Accessibility" src/components/Overlay.tsx`.
  </verify>
  <done>
    Zustand store uses AppContext wrapping TerminalContext + app_name + console state. show() calls get_app_context instead of get_terminal_context. resolveBadge() implements shell > console > app name priority. Overlay shows appropriate badge text. All context data stored for Phase 4 AI use. TypeScript compiles.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete badge system across terminals, browsers, and generic apps</name>
  <files>none</files>
  <action>
    Human verification of the complete context detection and badge system.

    Run `pnpm tauri dev` from the project root and verify the following:

    **Test 1: Terminal Badge (shell type)**
    1. Open Terminal.app and cd to a project directory
    2. Press Cmd+Shift+K (or configured hotkey)
    3. Verify: badge shows "zsh" (or your shell) below the input field
    4. Verify: spinner appears briefly, then badge appears

    **Test 2: iTerm2 Badge**
    5. Switch to iTerm2 (if installed)
    6. Press Cmd+Shift+K
    7. Verify: shell type badge appears correctly

    **Test 3: Browser Badge (no DevTools)**
    8. Open Chrome (or Safari, Firefox, Arc)
    9. Make sure DevTools is CLOSED
    10. Press Cmd+Shift+K
    11. Verify: badge shows "Chrome" (or "Safari", "Firefox", "Arc")
    12. Verify: badge does NOT say "Console"

    **Test 4: Browser Console Badge (DevTools open)**
    13. In Chrome, open DevTools (Cmd+Option+I or F12)
    14. Switch to the Console tab
    15. Press Cmd+Shift+K
    16. Verify: badge shows "Console" (not "Chrome")

    **Test 5: App Name Badge (non-terminal, non-browser)**
    17. Switch to Finder (or any non-terminal, non-browser app)
    18. Press Cmd+Shift+K
    19. Verify: badge shows "Finder" (or the app's cleaned name)

    **Test 6: Editor with Integrated Terminal**
    20. Open VS Code or Cursor with an integrated terminal open
    21. Make the integrated terminal the active pane
    22. Press Cmd+Shift+K
    23. Verify: badge shows "zsh" (shell type), NOT "Code" or "Cursor"

    **Test 7: Badge Priority Validation**
    24. Confirm badge priority matches: shell > console > app name
    25. Terminal always shows shell type (never app name)
    26. Browser with DevTools shows "Console" (never browser name)
    27. Browser without DevTools shows browser name
    28. All other apps show their cleaned name

    **Test 8: Accessibility Banner**
    29. If Accessibility permission denied: verify amber banner shows
    30. Click banner -> opens System Settings
    31. Grant permission if needed -> banner disappears

    **Test 9: Detection Timeout**
    32. Verify overlay appears within ~500ms even when detection is slow
    33. Verify badge area hidden when detection fails
  </action>
  <verify>
    All 9 test categories pass. Badge text correct for terminals (shell type), browsers with DevTools ("Console"), browsers without DevTools (browser name), generic apps (app name), and editors with terminals (shell type). Accessibility banner works. Detection does not stall overlay.
  </verify>
  <done>
    Human has verified: badge priority system works correctly -- shell type for terminals and editors, "Console" for browsers with DevTools, cleaned app name for everything else. Accessibility banner functions. Detection completes within timeout.
  </done>
</task>

</tasks>

<verification>
1. Badge shows shell type when frontmost app has a detected shell
2. Badge shows "Console" when browser has DevTools open
3. Badge shows cleaned app name for all other apps
4. Shell badge wins over app name for editors with integrated terminals
5. Chromium-based browsers show their own name (not "Chrome")
6. Console last line and app name stored in Zustand for Phase 4 AI
7. Spinner during detection, badge after, hidden on failure
8. Accessibility banner works correctly
9. Detection completes within 500ms
10. TypeScript compiles without errors
</verification>

<success_criteria>
- Badge priority: shell type > "Console" > app name implemented and verified
- All badge scenarios verified by human (terminals, browsers, DevTools, generic apps, editors)
- Context data stored in Zustand for Phase 4 AI consumption
- Accessibility banner still functional
- Human verification passes all 9 test categories
</success_criteria>

<output>
After completion, create `.planning/phases/03-terminal-context-reading/03-05-SUMMARY.md`
</output>
